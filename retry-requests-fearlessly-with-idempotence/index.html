<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Retry Requests Fearlessly with Idempotence - The Honest Coder</title><meta name="description" content="A practical guide to being fearless in the presence of duplicate service requests."><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="stylesheet" href="https://thehonestcoder.com/media/plugins/syntaxHighlighter/prism-black.css"><script type="gdpr-blocker/analytics" async src="https://www.googletagmanager.com/gtag/js?id=G-P87PBR2D4P"></script><script type="gdpr-blocker/analytics">window.dataLayer = window.dataLayer || [];
				  function gtag(){dataLayer.push(arguments);}
				  gtag('js', new Date());
				  gtag('config', 'G-P87PBR2D4P' );</script><link rel="canonical" href="https://thehonestcoder.com/retry-requests-fearlessly-with-idempotence/"><link rel="alternate" type="application/atom+xml" href="https://thehonestcoder.com/feed.xml"><link rel="alternate" type="application/json" href="https://thehonestcoder.com/feed.json"><meta property="og:title" content="Retry Requests Fearlessly with Idempotence"><meta property="og:image" content="https://thehonestcoder.com/media/posts/8/retry-requests-featured.webp"><meta property="og:image:width" content="1668"><meta property="og:image:height" content="1001"><meta property="og:site_name" content="The Honest Coder"><meta property="og:description" content="A practical guide to being fearless in the presence of duplicate service requests."><meta property="og:url" content="https://thehonestcoder.com//retry-requests-fearlessly-with-idempotence/"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@TheHonestCoder"><meta name="twitter:title" content="Retry Requests Fearlessly with Idempotence"><meta name="twitter:description" content="A practical guide to being fearless in the presence of duplicate service requests."><meta name="twitter:image" content="https://thehonestcoder.com/media/posts/8/retry-requests-featured.webp"><link rel="shortcut icon" href="https://thehonestcoder.com/media/website/hc-favicon.png" type="image/x-icon"><link rel="preload" href="https://thehonestcoder.com/assets/dynamic/fonts/publicsans/publicsans.woff2" as="font" type="font/woff2" crossorigin><link rel="stylesheet" href="https://thehonestcoder.com/assets/css/style.css?v=30c72d59656faab72e55eb4b4a720e22"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://thehonestcoder.com/retry-requests-fearlessly-with-idempotence/"},"headline":"Retry Requests Fearlessly with Idempotence","datePublished":"2020-09-09T12:00+03:00","dateModified":"2025-01-12T00:11+02:00","image":{"@type":"ImageObject","url":"https://thehonestcoder.com/media/posts/8/retry-requests-featured.webp","height":1001,"width":1668},"description":"A practical guide to being fearless in the presence of duplicate service requests.","author":{"@type":"Person","name":"Tautvydas Versockas","url":"https://thehonestcoder.com/authors/tautvydas-versockas/"},"publisher":{"@type":"Organization","name":"Tautvydas Versockas","logo":{"@type":"ImageObject","url":"https://thehonestcoder.com/media/website/hex-logo.webp","height":100,"width":100}}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="post-template"><div class="container"><div class="left-bar"><div class="left-bar__inner"><header class="header"><a class="logo" href="https://thehonestcoder.com/"><img src="https://thehonestcoder.com/media/website/hex-logo.webp" alt="The Honest Coder" width="100" height="100"></a><nav class="navbar"><button class="navbar__toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle__box"><span class="navbar__toggle__inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://thehonestcoder.com/" target="_self" aria-label="Home"><span>Home</span></a></li><li><a href="https://thehonestcoder.com/about/" target="_self" aria-label="About me"><span>About me</span></a></li><li><a href="https://thehonestcoder.com/speaking/" target="_self" aria-label="Speaking"><span>Speaking</span></a></li></ul></nav><a class="logo logo--atbottom" href="https://thehonestcoder.com/"><img src="https://thehonestcoder.com/media/website/hex-logo.webp" alt="The Honest Coder" width="100" height="100"></a></header></div></div><main class="main post"><article class="content"><figure class="content__featured-image content__featured-image--attop"><img src="https://thehonestcoder.com/media/posts/8/retry-requests-featured.webp" srcset="https://thehonestcoder.com/media/posts/8/responsive/retry-requests-featured-xs.webp 320w, https://thehonestcoder.com/media/posts/8/responsive/retry-requests-featured-sm.webp 480w, https://thehonestcoder.com/media/posts/8/responsive/retry-requests-featured-md.webp 768w, https://thehonestcoder.com/media/posts/8/responsive/retry-requests-featured-xl.webp 1024w" sizes="(min-width: 1460px) 938px, (min-width: 1200px) calc(75.83vw - 154px), (min-width: 1120px) 938px, (min-width: 900px) calc(55vw + 333px), 100vw" loading="eager" height="1001" width="1668" alt="Faking Exactly-Once Delivery with Idempotence book." aria-describedby="image-caption"></figure><div class="main__inner"><div class="content__meta"><div class="content__date"><time datetime="2020-09-09T12:00">Sep 9, 2020</time></div><span class="meta-separator date-meta-separator">â€¢</span> <span class="meta-separator reading-time-meta-separator">â€¢</span><div class="content__maintag"><a href="https://thehonestcoder.com/tags/system-design/" class="metadata__maintag">System Design</a></div></div><header class="content__header"><h1 class="content__title">Retry Requests Fearlessly with Idempotence</h1></header><div class="content__entry"><h2 id="9b1f" class="wp-block-heading">Idemfu*kingwhat?</h2><p id="b9d3">Every single day of our lives is unique â€” most of the things that happen will likely not happen again in the same manner. They occur exactly once. Unfortunately, that isnâ€™t the case with software systems and requests between them. Why should that matter? Imagine purchasing a new laptop and being charged twice because of some duplicate service requests. That doesnâ€™t sound fun, does it?</p><p id="c1af">In theory, exactly once request delivery is impossible â€” the classic <a href="https://en.wikipedia.org/wiki/Two_Generals%27_Problem" target="_blank" rel="nofollow noopener noreferrer">Two Generals Problem</a> illustrates the pitfalls and design challenges. However, in practice, we rarely care about delivering our requests exactly once. We usually go for the second-best thing â€” at least once delivery, where we keep sending the same service request until we are confident that it is received (it might be received multiple times). But hey, we donâ€™t want to get charged twice, right? We can avoid that by ensuring that handling the same request multiple times doesnâ€™t change the result beyond the initial application. In fact, thatâ€™s the essence of <a href="https://en.wikipedia.org/wiki/Idempotence" target="_blank" rel="nofollow noopener noreferrer">idempotence</a>.</p><p id="b2d7">Now that you have received a duplicate service request, how do you handle idempotence? Letâ€™s explore your options with a bank account example. The code examples are written inÂ C#Â because its syntax is relatively simple and should not be challenging for most developers to understand.</p><h2 id="722d" class="wp-block-heading">Maybe You Donâ€™t Need to Do Anything After All!</h2><p id="d0f5">Some requests are idempotent naturally, and you donâ€™t have to worry about retrying them. Take a simple bank account <a href="https://www.martinfowler.com/bliki/DDD_Aggregate.html" target="_blank" rel="nofollow noopener noreferrer">aggregate</a>, for instance:</p><pre class="language-csharp"><code>public sealed class Account
{
    public Guid Id { get; }
    public decimal Balance { get; private set; }

    public Account(Guid id, decimal balance)
    {
        if (id == default)
            throw new InvalidOperationException("Account id must be provided");

        if (balance &lt; 0)
            throw new InvalidOperationException("Balance cannot be negative");

        Id = id;
        Balance = balance;
    }

    public void Withdraw(decimal amount)
    {
        if (amount &lt; 0)
            throw new InvalidOperationException("Cannot withdraw negative amount");
        
        if (amount &gt; Balance)
            throw new InvalidOperationException("Cannot withdraw more than existing balance");

        Balance -= amount;
    }

    public void Deposit(decimal amount)
    {
        if (amount &lt; 0)
            throw new InvalidOperationException("Cannot deposit negative amount");
        
        Balance += amount;
    }
}
</code></pre><p>To open a new bank account, you can send anÂ <em>OpenAccountRequest</em>Â like this:</p><pre class="language-csharp"><code>public sealed class OpenAccountRequest
{
    public Guid AccountId { get; }
    public decimal Balance { get; }

    public OpenAccountRequest(Guid accountId, decimal balance)
    {
        AccountId = accountId;
        Balance = balance;
    }
}</code></pre><p id="35d5"><em>OpenAccountRequest</em> is idempotent as it is. Whenever you receive a request, you can check if an account with the sameÂ IDÂ exists in our database. If the account already exists, you know you received a duplicate request. Therefore, you can ignore it. Moreover, if your database guarantees accountÂ IDs to be unique, you can check for the duplicate key exception instead:</p><pre class="language-csharp"><code>public async Task HandleAsync(OpenAccountRequest request, CancellationToken token = default)
{
    var account = new Account(request.AccountId, request.Balance); 
    
    try
    {
        await _repository.InsertAsync(account, token);
    }
    catch (DuplicateKeyException)
    {
        //Ignore
    }
}</code></pre><p id="2ad8">Itâ€™s all fun and games until you try to withdraw or deposit money. If you send the same deposit request twice because of a network error â€” you deposit twice the money even though you initially intended to deposit it once. Twice the money â€” twice the fun!</p><h2 id="0000" class="wp-block-heading">Do You Know the Current State?</h2><p id="3f68">One way to handle duplicate requests is to ask for the current state of the aggregate. Strictly speaking, this solution is typically considered for a broader problem of optimistic concurrency than idempotence, and it doesnâ€™t identify duplicate requests. However, if you ask to provide the account balance in yourÂ <em>DepositToAccountRequest</em>, you will be capable of protecting yourself against duplicates:</p><pre class="language-csharp"><code>public sealed class DepositToAccountRequest
{
    public Guid AccountId { get; }
    public decimal Amount { get; }
    public decimal AccountBalance { get; }

    public DepositToAccountRequest(Guid accountId, decimal amount, decimal accountBalance)
    {
        AccountId = accountId;
        Amount = amount;
        AccountBalance = accountBalance;
    }
}</code></pre><pre class="language-csharp"><code>public async Task HandleAsync(DepositToAccountRequest request, CancellationToken token = default)
{
    var account = await _repository.GetAsync(request.AccountId, token) ?? 
        throw new EntityNotFoundException();

    account.Deposit(request.Amount);

    await _repository.UpdateAsync(account, request.AccountBalance, token);
}</code></pre><pre class="language-csharp"><code>public sealed class AccountRepository : IAccountRepository
{
    //....

    public async Task UpdateAsync(Account account, decimal expectedBalance, CancellationToken token = default)
    {
        var sql = "UPDATE Accounts SET Balance = @Balance WHERE Id = @Id AND Balance = @ExpectedBalance";
        var sqlParams = new
        {
            Id = account.Id, 
            Balance = account.Balance, 
            ExpectedBalance = expectedBalance
        };

        await using var connection = new SqlConnection(_connectionString);
        await connection.OpenAsync(token);
        
        var rowsAffected = await connection.ExecuteAsync(sql, sqlParams);
        if (rowsAffected == 0)
            throw new InvalidStateException();
    }

    //....
}</code></pre><p id="e60d">Since you canâ€™t identify duplicate requests, you canâ€™t be sure whether you received a duplicate request or the client wasnâ€™t aware that the balance had been changed. Therefore you would most likely reject all invalid state requests and ask the client to get the latest state and try again (hence no try-catch block ignoringÂ <em>InvalidStateException</em>).</p><p id="dbdb">This solution is relatively easy to implement and doesnâ€™t introduce technical details into our account aggregate. However, it is not very flexible since providing an account balance may not be enough for other requests to be protected in the same way. Not to mention that it could fail in highly concurrent scenarios, i.e., while you retry a successful withdrawal request, someone else deposits the same amount of money, making you withdraw twice the amount. To mitigate those issues, you can artificially generate a state by versioning your account. Whenever you change the account aggregate, you must increase its version:</p><pre class="language-csharp"><code>public sealed class Account
{
    public Guid Id { get; }
    public int Version { get; private set; }
    public decimal Balance { get; private set; }

    public Account(Guid id, decimal balance)
        : this(id, 0, balance) { }

    //Constructor to restore the state
    private Account(Guid id, int version, decimal balance)
    {
        if (id == default)
            throw new InvalidOperationException("Account id must be provided");

        if (version &lt; 0)
            throw new InvalidOperationException("Version cannot be negative");

        if (balance &lt; 0)
            throw new InvalidOperationException("Balance cannot be negative");

        Id = id;
        Version = version;
        Balance = balance;
    }

    public void Withdraw(decimal amount)
    {
        if (amount &lt; 0)
            throw new InvalidOperationException("Cannot withdraw negative amount");
        
        if (amount &gt; Balance)
            throw new InvalidOperationException("Cannot withdraw more than existing balance");

        Balance -= amount;
        Version++;
    }

    public void Deposit(decimal amount)
    {
        if (amount &lt; 0)
            throw new InvalidOperationException("Cannot deposit negative amount");
        
        Balance += amount;
        Version++;
    }
}</code></pre><pre class="language-csharp"><code>public sealed class DepositToAccountRequest
{
    public Guid AccountId { get; }
    public int AccountVersion { get; }
    public decimal Amount { get; }

    public DepositToAccountRequest(Guid accountId, int accountVersion, decimal amount)
    {
        AccountId = accountId;
        AccountVersion = accountVersion;
        Amount = amount;
    }
}</code></pre><pre class="language-csharp"><code>public async Task HandleAsync(DepositToAccountRequest request, CancellationToken token = default)
{
    var account = await _repository.GetAsync(request.AccountId, token) ??
        throw new EntityNotFoundException();

    account.Deposit(request.Amount);

    await _repository.UpdateAsync(account, request.Version, token);
}</code></pre><pre class="language-csharp"><code>public sealed class AccountRepository : IAccountRepository
{
    //....

    public async Task UpdateAsync(Account account, int expectedVersion, CancellationToken token = default)
    {
        var sql = "UPDATE Accounts SET Balance = @Balance, Version = @Version WHERE Id = @Id AND Version = @ExpectedVersion";
        var sqlParams = new
        {
            Id = account.Id, 
            Balance = account.Balance, 
            Version = account.Version,
            ExpectedVersion = expectedVersion
        };

        await using var connection = new SqlConnection(_connectionString);
        await connection.OpenAsync(token);
        
        var rowsAffected = await connection.ExecuteAsync(sql, sqlParams);
        if (rowsAffected == 0)
            throw new InvalidStateException();
    }

    //....
}</code></pre><p id="8471">Unlike the account balance, you can include the account version in your requests. Since you can only increase the version, highly concurrent scenarios are also covered. If you are using the <a href="https://thehonestcoder.com/the-promised-land-of-event-sourcing/" target="_blank" rel="noopener noreferrer">Event SourcingÂ pattern</a>, you likely already have a version in your aggregates.</p><p id="77e1">It is crucial to consider this approach's limitations. To send a request, you need to know the current state of the aggregate. If the aggregate changes rather frequently, using the system becomes quite tricky and inefficient since many requests get rejected because of an outdated state. But hey, at least you are not scared of duplicates anymore, right?</p><h2 id="ebf7" class="wp-block-heading">Just Put a Database Transaction All Over This!</h2><p id="a14b">Another widespread solution requires an <a href="https://en.wikipedia.org/wiki/ACID" target="_blank" rel="nofollow noopener noreferrer">ACID</a>-compliant database. First, you need to add uniqueÂ IDsÂ to your requests, which shouldnâ€™t be changed when retrying:</p><pre class="language-csharp"><code>public sealed class DepositToAccountRequest
{
    public Guid Id { get; }
    public Guid AccountId { get; }
    public decimal Amount { get; }

    public DepositToAccountRequest(Guid id, Guid accountId, decimal amount)
    {
        Id = id;
        AccountId = accountId;
        Amount = amount;
    }
}</code></pre><p>Then you have to create another database table that will store the history of requestÂ IDs. The table should guaranteeÂ IDsÂ are unique. When you receive a request, you need to insert the request ID into the new database table before persisting your aggregate state within a database transaction. If the requestÂ IDÂ is already stored, you know itâ€™s a duplicate request. Unlike with account balance or version, now you are actually making requests idempotent.</p><pre class="language-csharp"><code>public sealed class AccountRepository : IAccountRepository
{
    //....

    public async Task UpdateAsync(Account account, Guid requestId, CancellationToken token = default)
    {
        var requestSql = "INSERT INTO RequestIds VALUES (@Id)";
        var requestSqlParams = new 
        { 
            Id = requestId.ToString() 
        };

        var accountSql = "UPDATE Accounts SET Balance = @Balance WHERE Id = @Id";
        var accountSqlParams = new
        {
            Id = account.Id,
            Balance = account.Balance
        };

        await using var connection = new SqlConnection(_connectionString);
        await connection.OpenAsync(token);
        await using var transaction = await connection.BeginTransactionAsync(token);

        try
        {
            await connection.ExecuteAsync(requestSql, requestSqlParams);
        }
        catch (Exception e) when (IsDuplicateKeyException(e))
        {
            throw new DuplicateKeyException();
        }

        await connection.ExecuteAsync(accountSql, accountSqlParams);
        await transaction.CommitAsync(token);
    }

    //....
}</code></pre><pre class="language-csharp"><code>public async Task HandleAsync(DepositToAccountRequest request, CancellationToken token = default)
{
    var account = await _repository.GetAsync(request.AccountId, token) ??
        throw new EntityNotFoundException();

    account.Deposit(request.Amount);

    try
    {
        await _repository.UpdateAsync(account, request.Id, token);
    }
    catch (DuplicateRequestException)
    {
        //Ignore
    }
}</code></pre><p id="8f66">Can we optimize this? You probably donâ€™t need to store every requestÂ IDÂ since the dawn of time. Can you assume you never receive duplicate requests after some time? If thatâ€™s the case â€” you can have a process that periodically removesÂ IDsÂ from the history table, making it very lightweight.</p><h2 id="ab20" class="wp-block-heading">What if a Transaction Isnâ€™t an Option?</h2><p id="a6e9">Sometimes you donâ€™t have an ACID-compliant database, making transactions not an option anymore. What you can do instead is store requestÂ ID<em>sÂ </em>directly into your aggregate:</p><pre class="language-csharp"><code>public sealed class Account
{
    private readonly HashSet&lt;Guid&gt; _requestIds;
    public Guid Id { get; }
    public decimal Balance { get; private set; }

    public Account(Guid id, decimal balance)
        : this(id, balance, new HashSet&lt;Guid&gt;()) { }

    //Constructor to restore the state
    private Account(Guid id, decimal balance, HashSet&lt;Guid&gt; requestIds)
    {
        if (id == default)
            throw new InvalidOperationException("Account id must be provided");

        if (balance &lt; 0)
            throw new InvalidOperationException("Balance cannot be negative");

        if (requestIds == null)
            throw new ArgumentNullException(nameof(requestIds));

        Id = id;
        Balance = balance;
        _requestIds = requestIds;
    }

    public void SetRequestId(Guid id)
    {
        if (_requestIds.Contains(id))
            throw new InvalidOperationException("Duplicate request");

        _requestIds.Add(id);
    }

    public void Withdraw(decimal amount)
    {
        if (amount &lt; 0)
            throw new InvalidOperationException("Cannot withdraw negative amount");
        
        if (amount &gt; Balance)
            throw new InvalidOperationException("Cannot withdraw more than existing balance");

        Balance -= amount;
    }

    public void Deposit(decimal amount)
    {
        if (amount &lt; 0)
            throw new InvalidOperationException("Cannot deposit negative amount");
        
        Balance += amount;
    }
}</code></pre><pre class="language-csharp"><code>public async Task HandleAsync(DepositToAccountRequest request, CancellationToken token = default)
{
    var account = await _repository.GetAsync(request.AccountId, token) ??
        throw new EntityNotFoundException();

    try
    {
        account.SetRequestId(request.Id);
    }
    catch (InvalidOperationException)
    {
        //Ignore
        return;
    }

    account.Deposit(request.Amount);

    await _repository.UpdateAsync(account, token);
}</code></pre><p id="a180">This doesnâ€™t protect you against duplicates in highly concurrent scenarios. However, if you donâ€™t send your request retries concurrently (in most cases, you shouldnâ€™t), you donâ€™t have to worry about that.</p><p id="f5f5">If the aggregate is changed frequently, storing every requestÂ IDÂ might increase its size significantly. But if you only care about the most recent requests (like with the database table before), you can optimize this by storing only a certain number of the most recent operations.</p><p id="50de">Once again, if you are one of theÂ Event SourcingÂ folks, life sometimes is just a tiny bit better for you. Since you already store your aggregates as event streams, you can add a requestÂ IDÂ to each event. Whenever you rebuild your aggregate, you can reconstruct the request history and validate a new request against it:</p><pre class="language-csharp"><code>public abstract class EventSourcedAggregate : Entity
{
    private readonly HashSet&lt;Guid&gt; _requestIds = new HashSet&lt;Guid&gt;();
    private readonly List&lt;IVersionedEvent&gt; _events = new List&lt;IVersionedEvent&gt;();
    private Guid _requestId = Guid.NewGuid();

    protected EventSourcedAggregate(Guid id)
        : base(id) { }

    protected EventSourcedAggregate(Guid id, IEnumerable&lt;IVersionedEvent&gt; events)
        : this(id)
    {
        foreach (var @event in events)
            ApplyEvent(@event);
    }

    public int Version { get; private set; }

    public IReadOnlyList&lt;IVersionedEvent&gt; GetUncommittedEvents()
    {
        return _events;
    }

    public void MarkEventsAsCommitted()
    {
        _events.Clear();
    }

    public void SetRequestId(Guid id)
    {
        if (_requestIds.Contains(id))
            throw new InvalidOperationException("Duplicate request");

        _requestId = id;
    }

    protected void Raise(VersionedEvent @event)
    {
        @event.RequestId = _requestId;
        @event.SourceId = Id;
        @event.Version = Version + 1;
        _events.Add(@event);
        ApplyEvent(@event);
    }

    private void ApplyEvent(IVersionedEvent @event)
    {
        this.AsDynamic().Apply(@event);
        Version = @event.Version;
        if (!_requestIds.Contains(@event.RequestId))
            _requestIds.Add(@event.RequestId);
    }
}</code></pre><pre class="language-csharp"><code>public sealed class Account : EventSourcedAggregate
{
    public decimal Balance { get; }

    public Account(Guid id, IEnumerable&lt;IVersionedEvent&gt; events)
        : base(id, events) { }

    public Account(Guid id, decimal balance)
        : base(id)
    {
        if (id == default)
            throw new InvalidOperationException("Account id must be provided");

        if (balance &lt; 0)
            throw new InvalidOperationException("Balance cannot be negative");

        Raise(new AccountOpened(balance));
    }

    public void Withdraw(decimal amount)
    {
        if (amount &lt; 0)
            throw new InvalidOperationException("Cannot withdraw negative amount");
            
        if (amount &gt; _balance)
            throw new InvalidOperationException("Cannot withdraw more than existing balance");

        Raise(new WithdrawnFromAccount(amount));
    }

    public void Deposit(decimal amount)
    {
        if (amount &lt; 0)
            throw new InvalidOperationException("Cannot deposit negative amount");
            
        Raise(new DepositedToAccount(amount));
    }

    private void Apply(AccountOpened evt)
    {
        _balance = evt.Balance;
    }

    private void Apply(WithdrawnFromAccount evt)
    {
        _balance -= evt.Amount;
    }

    private void Apply(DepositedToAccount evt)
    {
        _balance += evt.Amount;
    }
}</code></pre><pre class="language-csharp"><code>public async Task HandleAsync(DepositToAccountRequest request, CancellationToken token = default)
{
    var account = await _repository.GetAsync(request, token);

    try
    {
        account.SetRequestId(request.Id);
    }
    catch (InvalidOperationException)
    {
        //Ignore duplicate request
        return;
    }

    account.Deposit(request.Amount);

    await _repository.SaveAsync(account, token);
}</code></pre><p>Thereâ€™s one more option if you are usingÂ Event Sourcing. It is based on generating deterministicÂ UUIDsÂ defined in <a href="http://www.ietf.org/rfc/rfc4122.txt" target="_blank" rel="nofollow noopener noreferrer">RFC 4122</a>. If your event store can guarantee unique eventÂ IDs,Â you can use a requestÂ IDÂ to generate resulting event IDs deterministically<em>.Â </em>The only thing left is to catch a duplicate key exception since your event store is handling the rest:</p><pre class="language-csharp"><code>public static class DeterministicGuid
{
    public static Guid Create(Guid val)
    {
        return Create(val.ToString());
    }

    public static Guid Create(string val)
    {
        using var generator = new NameBasedGenerator(HashType.SHA1);
        return generator.GenerateGuid(UUIDNameSpace.URL, val);
    }
}</code></pre><pre class="language-csharp"><code>public sealed class Repository&lt;TEventSourcedAggregate&gt; : IEventSourcedRepository&lt;TEventSourcedAggregate&gt; where TEventSourcedAggregate : EventSourcedAggregate
{
    //....

    public async Task SaveAsync(TEventSourcedAggregate aggregate, Guid requestId, CancellationToken token = default)
    {
        //....

        var nextIdGenerationSource = requestId;
        var eventsToSave = aggregate.GetUncommittedEvents().Select(evt =&gt;
        {
            var id = DeterministicGuid.Create(nextIdGenerationSource);
            nextIdGenerationSource = id;
            var type = evt.GetType().Name;
            var data = Serialize(evt);
            return new EventData(id, type, data);
        });

        //....
    }

    //....
}</code></pre><h2 id="8cde" class="wp-block-heading">Wow, You Are Still Reading? Itâ€™s Time to Summarize!</h2><p id="ee47">Thereâ€™s no right way to deal with idempotence â€” it depends solely on your business and technical requirements. Sometimes you might receive service requests that are idempotent naturally. At other times, if your aggregates donâ€™t change very often, it could make sense to provide the current aggregate state in your requests to deal with duplicate requests. Maybe you have anÂ ACID<em>-co</em>mpliant database? If thatâ€™s the case, you could go with database transactions since they are reasonably simple to implement, can be used with all of your requests, and donâ€™t leak technical details into the domain. Do you useÂ the Event Sourcing<em>Â </em>pattern with an event store guaranteeing unique eventÂ IDs<em>Â </em>(i.e.,Â SQL Server)<em>?Â </em>Then you could avoid transactions by generating deterministic eventÂ IDs. What if your event store doesnâ€™t ensure unique eventÂ IDsÂ (i.e., Greg Youngâ€™s <a href="https://eventstore.com/" target="_blank" rel="nofollow noopener noreferrer">Event Store</a><em>)?Â </em>You could store requestÂ IDsÂ in your aggregates instead. Not to mention that there are likely other ways used in specific scenarios that I have not covered.</p><hr><p id="8ff9"><em>Thank you for reading. Iâ€™d love to hear how you handle idempotent requests.</em></p></div><footer class="content__footer"><div class="content__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fthehonestcoder.com%2Fretry-requests-fearlessly-with-idempotence%2F" class="js-share facebook tltp tltp--top" aria-label="Facebook" rel="nofollow noopener noreferrer"><svg><use xlink:href="https://thehonestcoder.com/assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fthehonestcoder.com%2Fretry-requests-fearlessly-with-idempotence%2F&amp;via=%40TheHonestCoder&amp;text=Retry%20Requests%20Fearlessly%20with%20Idempotence" class="js-share twitter tltp tltp--top" aria-label="Twitter" rel="nofollow noopener noreferrer"><svg><use xlink:href="https://thehonestcoder.com/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fthehonestcoder.com%2Fretry-requests-fearlessly-with-idempotence%2F" class="js-share linkedin tltp tltp--top" aria-label="Share with LinkedIn" rel="nofollow noopener noreferrer"><svg><use xlink:href="https://thehonestcoder.com/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span></a></div></footer></div></article><div class="content__section post__related"><div class="main__inner"><h3 class="content__section__title">Related post</h3><div class="post__related__wrap"><article class="c-card"><div class="c-card__meta"><div class="c-card__author"><a href="https://thehonestcoder.com/authors/tautvydas-versockas/">Tautvydas Versockas</a></div><time datetime="2021-07-14T12:00">Jul 14, 2021 </time><a href="https://thehonestcoder.com/tags/system-design/" class="c-card-tag">System Design</a></div><a href="https://thehonestcoder.com/service-leader-election-with-net-and-apache-zookeeper/" class="c-card__image"><img src="https://thehonestcoder.com/media/posts/15/zookeeper-featured.webp" srcset="https://thehonestcoder.com/media/posts/15/responsive/zookeeper-featured-xs.webp 320w, https://thehonestcoder.com/media/posts/15/responsive/zookeeper-featured-sm.webp 480w" sizes="(min-width: 700px) 200px, (min-width: 480px) 160px, calc(100vw - 50px)" loading="lazy" height="735" width="1225" alt="Apache ZooKeeper logo."></a><header class="c-card__header"><h2 class="c-card__title"><a href="https://thehonestcoder.com/service-leader-election-with-net-and-apache-zookeeper/">Service Leader Election With .NET and Apache ZooKeeper</a></h2><p>Building reliable distributed software solutions is not an easy task. However, it gets slightly easier using Apache ZooKeeper.</p></header></article><article class="c-card"><div class="c-card__meta"><div class="c-card__author"><a href="https://thehonestcoder.com/authors/tautvydas-versockas/">Tautvydas Versockas</a></div><time datetime="2023-12-17T12:00">Dec 17, 2023 </time><a href="https://thehonestcoder.com/tags/system-design/" class="c-card-tag">System Design</a></div><a href="https://thehonestcoder.com/ddd-ef-core-8/" class="c-card__image"><img src="https://thehonestcoder.com/media/posts/6/ddd-ef-core-featured.webp" srcset="https://thehonestcoder.com/media/posts/6/responsive/ddd-ef-core-featured-xs.webp 320w, https://thehonestcoder.com/media/posts/6/responsive/ddd-ef-core-featured-sm.webp 480w" sizes="(min-width: 700px) 200px, (min-width: 480px) 160px, calc(100vw - 50px)" loading="lazy" height="818" width="1364" alt="Spider-Man reading &quot;Domain-Driven Design: Tackling Complexity in Heart of Software&quot; by Eric Evans."></a><header class="c-card__header"><h2 class="c-card__title"><a href="https://thehonestcoder.com/ddd-ef-core-8/">Domain-Driven Design With Entity Framework Core 8</a></h2><p>Learn to implement Domain-Driven Design patterns using Entity Framework Core 8!</p></header></article><article class="c-card"><div class="c-card__meta"><div class="c-card__author"><a href="https://thehonestcoder.com/authors/tautvydas-versockas/">Tautvydas Versockas</a></div><time datetime="2025-01-05T12:00">Jan 5, 2025 </time><a href="https://thehonestcoder.com/tags/technical-leadership/" class="c-card-tag">Technical Leadership</a></div><a href="https://thehonestcoder.com/sabotage-your-company/" class="c-card__image"><img src="https://thehonestcoder.com/media/posts/5/sabotage-company-featured-2.webp" srcset="https://thehonestcoder.com/media/posts/5/responsive/sabotage-company-featured-2-xs.webp 320w, https://thehonestcoder.com/media/posts/5/responsive/sabotage-company-featured-2-sm.webp 480w" sizes="(min-width: 700px) 200px, (min-width: 480px) 160px, calc(100vw - 50px)" loading="lazy" height="1248" width="2079" alt="A raccoon planning something suspicious."></a><header class="c-card__header"><h2 class="c-card__title"><a href="https://thehonestcoder.com/sabotage-your-company/">How to Sabotage Your Software Company in 10 Easy Steps (Without Getting Caught)</a></h2><p>From creating chaos with endless meetings to enforcing inefficient processes, learn the art of subtle sabotage!</p></header></article></div></div></div><div class="content__section banner"><div class="main__inner"><script src="https://giscus.app/client.js" data-repo="tautvydasversockas/thehonestcoder-discussions" data-repo-id="R_kgDOL-IysQ" data-category="Announcements" data-category-id="DIC_kwDOL-Iysc4CffdA" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en" data-loading="lazy" crossorigin="anonymous" async></script></div></div></main><div class="right-bar"><div class="right-bar__inner"><div class="sidebar"><section class="box personal-picture"><a href="https://thehonestcoder.com/about" class="personal-picture__image"><img src="https://thehonestcoder.com/media/files/cropped-me.webp" alt="Tautvydas Versockas"></a></section><section class="box buymeacoffee"><a href="https://www.buymeacoffee.com/tautvydasverso" target="_blank"><img align="left" src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" height="50" width="210" alt="tautvydasverso"></a></section><section class="box tags"><h3 class="box__title">Recommended Topics</h3><ul class="tags__list"><li class="tags__item"><a href="https://thehonestcoder.com/tags/net/" class="btn btn--gray">.NET</a></li><li class="tags__item"><a href="https://thehonestcoder.com/tags/databases/" class="btn btn--gray">Databases</a></li><li class="tags__item"><a href="https://thehonestcoder.com/tags/fun/" class="btn btn--gray">Fun</a></li><li class="tags__item"><a href="https://thehonestcoder.com/tags/life/" class="btn btn--gray">Life</a></li><li class="tags__item"><a href="https://thehonestcoder.com/tags/system-design/" class="btn btn--gray">System Design</a></li><li class="tags__item"><a href="https://thehonestcoder.com/tags/technical-leadership/" class="btn btn--gray">Technical Leadership</a></li></ul></section><div class="box follow"><a href="https://github.com/tautvydasversockas" class="tltp tltp--top" target="_blank" aria-label="GitHub"><svg><use xlink:href="https://thehonestcoder.com/assets/svg/svg-map.svg#github"/></svg> </a><a href="https://x.com/TheHonestCoder" class="tltp tltp--top" target="_blank" aria-label="Twitter"><svg><use xlink:href="https://thehonestcoder.com/assets/svg/svg-map.svg#twitter"/></svg> </a><a href="https://www.linkedin.com/in/tautvydasversockas/" class="tltp tltp--top" target="_blank" aria-label="LinkedIn"><svg><use xlink:href="https://thehonestcoder.com/assets/svg/svg-map.svg#linkedin"/></svg> </a><a href="https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2Fthehonestcoder.com%2Ffeed%2F" class="tltp tltp--top" target="_blank" aria-label="RSS"><svg><use xlink:href="https://thehonestcoder.com/assets/svg/svg-map.svg#rss"/></svg></a></div><div class="box copyright">Â© 2025 Tautvydas Versockas</div></div></div></div></div><script defer="defer" src="https://thehonestcoder.com/assets/js/scripts.min.js?v=b2d91bcadbf5db401b76eb5bb3092eb7"></script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><script>'use strict'; document.addEventListener('DOMContentLoaded', function() { var obfElements = document.querySelectorAll('.obfuscated-email'); obfElements.forEach(function(elem) { var dataType = elem.getAttribute('data-type'); var encodedEmail = elem.getAttribute('data-email'); var user = elem.getAttribute('data-user'); var domain = elem.getAttribute('data-domain'); var decodedEmail = ''; if (user && domain) { decodedEmail = user.split('').reverse().join('') + '@' + domain.split('').reverse().join(''); } else if (encodedEmail) { const parts = encodedEmail.split('@'); if (parts.length === 2) { decodedEmail = parts[0].split('').reverse().join('') + '@' + parts[1].split('').reverse().join(''); } else { decodedEmail = encodedEmail; } } if (dataType === 'mailto') { var originalText = elem.textContent.trim(); var a = document.createElement('a'); a.href = 'mailto:' + decodedEmail; if (elem.classList.length > 0) { a.className = elem.className; } if (originalText === '') { a.textContent = decodedEmail; } else { a.textContent = originalText; } elem.parentNode.replaceChild(a, elem); } else if (dataType === 'text') { var textNode = document.createTextNode(decodedEmail); elem.parentNode.replaceChild(textNode, elem); } }); });</script><script type="text/javascript">document.addEventListener("DOMContentLoaded", function() {
            if (window.location.pathname !== '/') {
                function calculateReadingTime() {
                    let totalWords = 0;

                    const textElements = document.querySelectorAll('.content__entry p');
                    textElements.forEach(element => {
                        totalWords += element.innerText.split(' ').filter(Boolean).length;
                    });

                    const headerElements = document.querySelectorAll('.content__entry .wp-block-heading');
                    headerElements.forEach(element => {
                        totalWords += element.innerText.split(' ').filter(Boolean).length;
                    });

                    const codeElements = document.querySelectorAll('.content__entry pre code');
                    codeElements.forEach(element => {
                        totalWords += element.innerText.split(' ').filter(Boolean).length;
                    });

                    const wordsPerMinute = 200;
                    const readingTimeDecimal = totalWords / wordsPerMinute;
                    const readingTimeMinutes = Math.floor(readingTimeDecimal);
                    const fractionalMinute = readingTimeDecimal - readingTimeMinutes;
                    const readingTimeSeconds = Math.round(fractionalMinute * 60);
                    const timeString = readingTimeMinutes + (readingTimeSeconds > 29 ? 1 :0);
                    const finalText = '%s min read'.replace('%s', timeString);

                    const readingTimeElement = document.createElement('div');
                    readingTimeElement.className = 'reading-time';                
                    readingTimeElement.textContent = finalText;
                    const targetElement = document.querySelector('.date-meta-separator');
                    if (targetElement) 
                        targetElement.insertAdjacentElement('afterend', readingTimeElement);
                }
                calculateReadingTime();
            }            
        });</script><script defer="defer" src="https://thehonestcoder.com/media/plugins/syntaxHighlighter/prism.js"></script><script defer="defer" src="https://thehonestcoder.com/media/plugins/syntaxHighlighter/clipboard.min.js"></script><script defer="defer" src="https://thehonestcoder.com/media/plugins/syntaxHighlighter/prism-copy-to-clipboard.min.js"></script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">We use cookies to enhance your browsing experience and analyze our traffic.</div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--link pcb__btn--configure" aria-haspopup="dialog">Manage preferences</button> <button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><div class="pcb__popup" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-popup-title"><div class="pcb__popup__wrapper"><div class="pcb__inner pcb__popup__inner"><div class="pcb__popup__heading"><div id="pcb-popup-title" role="heading" aria-level="2" class="pcb__title">Cookie settings</div><button class="pcb__popup__close" aria-label="Close"></button></div><div class="pcb__popup__content"><div class="pcb__txt pcb__popup__txt">We use cookies to enhance your browsing experience and analyze our traffic. By clicking "Accept All", you consent to our use of cookies.</div><ul class="pcb__groups"><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Analytics</summary></details><div class="pcb__popup__switch"><input type="checkbox" data-group-name="analytics" id="analytics-cookies"> <label for="analytics-cookies">Analytics</label></div></li></ul></div><div class="pcb__buttons pcb__popup__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button> <button type="button" class="pcb__btn pcb__btn--reject"></button> <button type="button" class="pcb__btn pcb__btn--save">Save settings</button></div></div></div></div><div class="pcb__overlay" aria-hidden="true"></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>window.dataLayer = window.dataLayer || [];
                function gtag() { dataLayer.push(arguments); }

                window.publiiCBGCM = {
                    defaultState: {"ad_storage":false,"ad_personalization":false,"ad_user_data":false,"analytics_storage":true,"personalization_storage":false,"functionality_storage":false,"security_storage":false},
                    groups: [{"cookieGroup":"","ad_storage":false,"ad_personalization":false,"ad_user_data":false,"analytics_storage":true,"personalization_storage":false,"functionality_storage":false,"security_storage":false}]
                };
            
            (function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('ðŸª Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('ðŸª GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('ðŸª Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('ðŸª GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('ðŸª Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && cbConfig.initialLsState.indexOf(allowedGroup) === -1) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('ðŸª GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('ðŸª Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('ðŸª Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('ðŸª Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('ðŸª Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>