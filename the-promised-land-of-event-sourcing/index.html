<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>The Promised Land of Event Sourcing - The Honest Coder</title><meta name="description" content="The guide you should read before starting with Event Sourcing."><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="stylesheet" href="./../media/plugins/syntaxHighlighter/prism-black.css"><script type="gdpr-blocker/Google" async src="https://www.googletagmanager.com/gtag/js?id=G-P87PBR2D4P"></script><script type="gdpr-blocker/Google">window.dataLayer = window.dataLayer || [];
				  function gtag(){dataLayer.push(arguments);}
				  gtag('js', new Date());
				  gtag('config', 'G-P87PBR2D4P' );</script><link rel="canonical" href="./../the-promised-land-of-event-sourcing/"><link rel="shortcut icon" href="./../media/website/hc-favicon.png" type="image/x-icon"><link rel="preload" href="./../assets/dynamic/fonts/publicsans/publicsans.woff2" as="font" type="font/woff2" crossorigin><link rel="stylesheet" href="./../assets/css/style.css?v=30c72d59656faab72e55eb4b4a720e22"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"./../the-promised-land-of-event-sourcing/"},"headline":"The Promised Land of Event Sourcing","datePublished":"2020-09-09T12:01+03:00","dateModified":"2025-01-12T18:07+02:00","image":{"@type":"ImageObject","url":"./../media/posts/9/event-sourcing-featured.webp","height":1241,"width":2070},"description":"The guide you should read before starting with Event Sourcing.","author":{"@type":"Person","name":"Tautvydas Versockas","url":"./../authors/tautvydas-versockas/"},"publisher":{"@type":"Organization","name":"Tautvydas Versockas","logo":{"@type":"ImageObject","url":"./../media/website/hex-logo.webp","height":100,"width":100}}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="post-template"><div class="container"><div class="left-bar"><div class="left-bar__inner"><header class="header"><a class="logo" href="./../"><img src="./../media/website/hex-logo.webp" alt="The Honest Coder" width="100" height="100"></a><nav class="navbar"><button class="navbar__toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle__box"><span class="navbar__toggle__inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="./../" target="_self" aria-label="Home"><span>Home</span></a></li><li><a href="./../about/" target="_self" aria-label="About me"><span>About me</span></a></li><li><a href="./../speaking/" target="_self" aria-label="Speaking"><span>Speaking</span></a></li></ul></nav><a class="logo logo--atbottom" href="./../"><img src="./../media/website/hex-logo.webp" alt="The Honest Coder" width="100" height="100"></a></header></div></div><main class="main post"><article class="content content--attop"><header class="hero content__header"><div class="main__inner"><h1>The Promised Land of Event Sourcing</h1></div></header><div class="main__inner"><div class="content__meta"><div class="content__date"><time datetime="2020-09-09T12:01">Sep 9, 2020</time></div><span class="meta-separator date-meta-separator">•</span> <span class="meta-separator reading-time-meta-separator">•</span><div class="content__maintag"><a href="./../tags/system-design/" class="metadata__maintag">System Design</a></div></div><div class="content__entry"><p>If you have ever developed a software system in an inherently complex business domain, I bet you know how complicated it could get. As a software engineer, I had an epiphany about dealing with complex business domains when I heard about <a href="./../once-upon-a-time-on-valentines-day/" target="_blank" rel="noopener noreferrer">DDD</a> (domain-driven design) for the first time. A few years later, working in the financial field, I met some brilliant people using a DDD pattern called Event Sourcing. It took me quite a few days to get a grasp of it. It was so different yet so elegant. My only regret now is that I didn't hear about Event Sourcing earlier.</p><blockquote><div class="uagb-blockquote__content">Every software system starts as the most innocent greenfield project. After all those legacy systems that you have worked on, you believe that this time it’s going to be different. This time it’s finally going to be better. A couple of weeks in and you feel like a new person, you feel proud — it’s your gorgeous baby after all. Suddenly, a few unexpected business requirements later, you realize that it’s no longer your beautiful child. It’s the <a href="https://en.wikipedia.org/wiki/Kraken" target="_blank" rel="nofollow noopener noreferrer">Kraken</a> that has been released! By you! What have you done? Well… Off you go… To the next project!</div><div> </div><div><cite class="uagb-blockquote__author">- The Honest Coder</cite></div></blockquote><p>I spent quite some time reading books and articles, discussing with experts in this field, and implementing the pattern myself. As a result, I wrote this guide, which I believe is one of the quickest ways to start with Event Sourcing.</p><h2 class="wp-block-heading">What Is Event Sourcing?</h2><p>We're used to the "classic" way of storing all application state changes as the latest state of our business model <a href="https://martinfowler.com/bliki/DDD_Aggregate.html" target="_blank" rel="nofollow noopener noreferrer">aggregates</a>, such as an <em>Account </em>or an <em>Order</em>. It's not unusual to find those kinds of systems to be <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete" target="_blank" rel="nofollow noopener noreferrer">CRUD</a>-based and built around relational databases. Unlike the "classic" approach, when using the Event Sourcing pattern, we persist an application state changes as a sequence of state-changing events — immutable business-related information about things that happened in the past. In a nutshell, Event Sourcing is just a different way to store data. Let's take a hypothetical payments application, for example. Whenever we make a new payment, a new <em>PaymentMade </em>event is appended to the <em>Account</em> aggregate events list and persisted within a single atomic operation. Later, the <em>Account </em>balance can be reconstructed by replaying persisted <em>PaymentMade</em> events.</p><p>Event Sourcing allows tracking all business-related events within an application, which is often extremely important in specific domains. I can't imagine a bank that would not allow clients to view their transactions. At the same time, most people would certainly appreciate the ability to check what happened to a brand-new smartphone that was supposed to arrive on their doorstep one week ago. Moreover, we can use events to reconstruct past aggregate states to solve complicated issues or roll back unwanted changes. </p><p>If you're like me before I knew anything about Event Sourcing, you should have more questions than answers by now. </p><h2 class="wp-block-heading">Why Would One Use Event Sourcing?</h2><p>Event Sourcing is by no means the silver bullet for software systems. Yet it can be an incredible tool if you know all the whens and the hows.</p><p>Event Sourcing provides a complete audit trail of business transactions. You can't delete a transaction or change it once it has happened. You can use those stored transactions to determine the system's state at any previous point in time by querying the events up to that point in time. It enables you to answer historical questions from the business about the system.</p><p>Troubleshooting is another fantastic Event Sourcing advantage. You can troubleshoot problems in a production system by copying the production event store and replaying it in a test environment. By troubleshooting, you might discover source code errors. Rather than performing risky manual data adjustments, you can fix the code and replay the event stream, allowing the system to recalculate values correctly based on the new code version.</p><p>Event Sourcing often leads to better performance and scalability than complex relational storage models since you only use append-only operations for small immutable event objects. Having append-only operations allows you to reap the benefits of databases such as <a href="https://cassandra.apache.org/" target="_blank" rel="nofollow noopener noreferrer">Cassandra</a>. Moreover, Event Sourcing is usually combined with <a href="https://martinfowler.com/bliki/CQRS.html" target="_blank" rel="noreferrer noopener nofollow">CQRS</a>, which could be a crazy improvement compared to the "classic" relational storage models.</p><p>Event Sourcing is an excellent fit in distributed systems (e.g., microservices architecture). You can publish events to notify other subsystems of changes to the application's state in a considerably decoupled manner. Although you can do that without Event Sourcing, having an event-based system makes it a lot easier.</p><p>While any one of those benefits could be handy on its own, having them all combined often makes Event Sourcing a no-brainer.</p><h2 class="wp-block-heading">Yes, Yes, Yes, but Where Is The Code?</h2><p>I wouldn't be surprised if, at this point, you weren't completely sold on the idea. The concept might seem difficult to grasp and evaluate whether all of these benefits are real or I am just a <a href="https://en.wikipedia.org/wiki/Snake_oil" target="_blank" rel="nofollow noopener noreferrer">snake oil salesman</a> trying to sell you my goods. Hopefully, the code will provide you with some answers.</p><p>The code examples are written in C# because its syntax is relatively simple and should not be challenging for most developers. However, you could implement the same thing in many different programming languages, even functional ones (see the resources section).</p><p>Let's define the <em>Account </em>aggregate model together with some basic operations:</p><pre class="language-csharp"><code>public sealed class Account
{
    private Guid Id;
    private decimal _balance;

    public static Account Open(Guid id, decimal balance)
    {

    }

    public void Withdraw(decimal amount)
    {

    }

    public void Deposit(decimal amount)
    {
  
    }
}</code></pre><p>Instead of going for the "classic" way, we need to split each of our methods into two parts : validating the data and raising events and applying events. This separation is crucial since we will restore the <em>Account</em> from our event store by applying events.</p><pre class="language-csharp"><code>public abstract class EventSourcedAggregate
{
    private readonly List&lt;Event&gt; _events = new List&lt;Event&gt;();

    public Guid Id { get; protected set; }
    public int Version { get; private set; }

    public void LoadFromHistory(IEnumerable&lt;Event&gt; events)
    {
        foreach (var @event in events)
            ApplyEvent(@event);
    }

    public IReadOnlyList&lt;Event&gt; GetUncommittedEvents()
    {
        return _events;
    }

    public void MarkEventsAsCommitted()
    {
        _events.Clear();
    }

    protected void Raise(Event @event)
    {
        @event.Version = Version + 1;
        _events.Add(@event);
        ApplyEvent(@event);
    }

    public void ApplyEvent(Event @event)
    {
        this.AsDynamic().Apply(@event);
        Version++;
    }
}

public sealed class Account : EventSourcedAggregate
{
    private decimal _balance;

    public static Account Open(Guid id, decimal balance)
    {
        if (balance &lt; 0)
            throw new InvalidOperationException("Balance cannot be negative.");

        var account = new Account();
        account.Raise(new AccountOpened(id, balance));
        return account;
    }

    public void Withdraw(decimal amount)
    {
        if (amount &lt;= 0)
            throw new InvalidOperationException("Amount must be positive.");

        if (amount &gt; _balance)
            throw new InvalidOperationException("Cannot withdraw more than balance.");

        Raise(new WithdrawnFromAccount(Id, amount));
    }

    public void Deposit(decimal amount)
    {
        if (amount &lt;= 0)
            throw new InvalidOperationException("Amount must be positive.");

        Raise(new DepositedToAccount(Id, amount));
    }

    private void Apply(AccountOpened @event)
    {
        Id = @event.AccountId;
        _balance = @event.Balance;
    }

    private void Apply(WithdrawnFromAccount @event)
    {
        _balance -= @event.Amount;
    }

    private void Apply(DepositedToAccount @event)
    {
        _balance += @event.Amount;
    }
}

public abstract class Event
{
    public int Version { get; set; }
}

public sealed class AccountOpened : Event
{
    public Guid AccountId { get; }
    public decimal Balance { get; }

    public AccountOpened(Guid accountId, decimal balance)
    {
        AccountId = accountId;
        Balance = balance;
    }
}

public sealed class DepositedToAccount : Event
{
    public Guid AccountId { get; }
    public decimal Amount { get; }

    public DepositedToAccount(Guid accountId, decimal amount)
    {
        AccountId = accountId;
        Amount = amount;
    }
}

public sealed class WithdrawnFromAccount : Event
{
    public Guid AccountId { get; }
    public decimal Amount { get; }

    public WithdrawnFromAccount(Guid accountId, decimal amount)
    {
        AccountId = accountId;
        Amount = amount;
    }
}</code></pre><p>Let's add some <a href="./../types-of-messages-in-message-driven-systems/" target="_blank" rel="nofollow noopener noreferrer">command</a> handlers to orchestrate our application:</p><pre class="language-csharp"><code>public sealed class AccountCommandHandlers
{
    private readonly IEventSourcedRepository&lt;Account&gt; _repository;

    public AccountCommandHandlers(IEventSourcedRepository&lt;Account&gt; repository)
    {
        _repository = repository;
    }

    public async Task HandleAsync(OpenAccount command)
    {
        var account = Account.Open(command.AccountId, command.Balance);
        await _repository.SaveAsync(account);
    }

    public async Task HandleAsync(DepositToAccount command)
    {
        var account = await _repository.GetAsync(command.AccountId) ??
            throw new EntityNotFoundException(nameof(Account), command.AccountId);

        account.Deposit(command.Amount);
        await _repository.SaveAsync(account);
    }

    public async Task HandleAsync(WithdrawFromAccount command)
    {
        var account = await _repository.GetAsync(command.AccountId) ??
            throw new EntityNotFoundException(nameof(Account), command.AccountId);

        account.Withdraw(command.Amount);
        await _repository.SaveAsync(account);
    }
}

public sealed class OpenAccount
{
    public Guid AccountId { get; }
    public decimal Balance { get; }

    public OpenAccount(Guid accountId, decimal balance)
    {
        AccountId = accountId;
        Balance = balance;
    }
}

public sealed class DepositToAccount
{
    public Guid AccountId { get; }
    public decimal Amount { get; }

    public DepositToAccount(Guid accountId, decimal amount)
    {
        AccountId = accountId;
        Amount = amount;
    }
}

public sealed class WithdrawFromAccount
{
    public Guid AccountId { get; }
    public decimal Amount { get; }

    public WithdrawFromAccount(Guid accountId, decimal amount)
    {
        AccountId = accountId;
        Amount = amount;
    }
}</code></pre><p>This is how we could implement the repository if we were to use Greg Young's <a href="https://eventstore.com/" target="_blank" rel="nofollow noopener noreferrer">Event Store</a><em>:</em></p><pre class="language-csharp"><code>public sealed class EventStore : IEventStore
{
    private readonly IEventStoreConnection _connection;

    public EventStore(IEventStoreConnection connection)
    {
        _connection = connection;
    }

    public async IAsyncEnumerable&lt;Event&gt; GetAggregateEventsAsync&lt;TEventSourcedAggregate&gt;(Guid aggregateId)
        where TEventSourcedAggregate : EventSourcedAggregate
    {
        var streamName = GetAggregateStreamName&lt;TEventSourcedAggregate&gt;(aggregateId);
        StreamEventsSlice currentSlice;
        var nextSliceStart = (long)StreamPosition.Start;

        do
        {
            currentSlice = await _connection.ReadStreamEventsForwardAsync(streamName, nextSliceStart, 10, false);
            nextSliceStart = currentSlice.NextEventNumber;

            foreach (var resolvedEvent in currentSlice.Events)
                yield return EventStoreSerializer.Deserialize(resolvedEvent);

        } while (!currentSlice.IsEndOfStream);
    }

    public async Task SaveAggregateEventsAsync&lt;TEventSourcedAggregate&gt;(Guid aggregateId, IEnumerable&lt;Event&gt; events, int expectedVersion)
        where TEventSourcedAggregate : EventSourcedAggregate
    {
        var streamName = GetAggregateStreamName&lt;TEventSourcedAggregate&gt;(aggregateId);
        var eventsToSave = events.Select(@event =&gt; EventStoreSerializer.Serialize(@event));
        await _connection.AppendToStreamAsync(streamName, expectedVersion, eventsToSave);
    }

    private static string GetAggregateStreamName&lt;TEventSourcedAggregate&gt;(Guid aggregateId)
        where TEventSourcedAggregate : EventSourcedAggregate
    {
        return $"{typeof(TEventSourcedAggregate).Name}-{aggregateId}";
    }
}

public sealed class EventSourcedRepository&lt;TEventSourcedAggregate&gt; : IEventSourcedRepository&lt;TEventSourcedAggregate&gt;
       where TEventSourcedAggregate : EventSourcedAggregate, new()
{
    private readonly IEventStore _eventStore;

    public EventSourcedRepository(IEventStore eventStore)
    {
        _eventStore = eventStore;
    }

    public async Task SaveAsync(TEventSourcedAggregate aggregate)
    {
        var uncommittedEvents = aggregate.GetUncommittedEvents();
        if (!uncommittedEvents.Any())
            return;

        var originalVersion = aggregate.Version - uncommittedEvents.Count;
        var expectedVersion = originalVersion == 0
            ? ExpectedVersion.NoStream
            : originalVersion - 1;

        try
        {
            await _eventStore.SaveAggregateEventsAsync&lt;TEventSourcedAggregate&gt;(aggregate.Id, uncommittedEvents, expectedVersion);
        }
        catch (WrongExpectedVersionException e)
            when (e.ExpectedVersion == ExpectedVersion.NoStream)
        {
            throw new DuplicateKeyException(aggregate.Id);
        }

        aggregate.MarkEventsAsCommitted();
    }

    public async Task&lt;TEventSourcedAggregate?&gt; GetAsync(Guid id)
    {
        TEventSourcedAggregate? aggregate = null;

        await foreach (var @event in _eventStore.GetAggregateEventsAsync&lt;TEventSourcedAggregate&gt;(id))
            (aggregate ??= new TEventSourcedAggregate()).ApplyEvent(@event);

        return aggregate;
    }
}</code></pre><p>This is what the stored data looks like in the Event Store:</p><figure class="post__image post__image--wide"><img loading="lazy" src="./../media/posts/9/event-store-1.webp" alt="Account events stream in Event Store." width="1000" height="298" sizes="(min-width: 760px) 660px, calc(93.18vw - 30px)" srcset="./../media/posts/9/responsive/event-store-1-xs.webp 320w, ./../media/posts/9/responsive/event-store-1-sm.webp 480w, ./../media/posts/9/responsive/event-store-1-md.webp 768w, ./../media/posts/9/responsive/event-store-1-xl.webp 1024w"><figcaption><em>Account </em>events stream in Event Store.</figcaption></figure><figure class="post__image"><figure class="post__image post__image--wide"><img loading="lazy" src="./../media/posts/9/event-store-2.webp" alt="DepositedToAccount event in Event Store." width="1000" height="488" sizes="(min-width: 760px) 660px, calc(93.18vw - 30px)" srcset="./../media/posts/9/responsive/event-store-2-xs.webp 320w, ./../media/posts/9/responsive/event-store-2-sm.webp 480w, ./../media/posts/9/responsive/event-store-2-md.webp 768w, ./../media/posts/9/responsive/event-store-2-xl.webp 1024w"></figure><figcaption><em>DepositedToAccount </em>event in Event Store.</figcaption></figure><p>In a nutshell, the data is a complete log of past events. Now, whenever the business throws you a tricky "what happened"<em> </em>question, you can give a detailed answer, feel like the smartest person in the room, and, hopefully, get a raise.</p><p>Have you noticed the <em>Version</em>? The <em>Version</em> enables us to time-travel in the realm of Event Sourcing. To get a specific <em>Account </em>version, we can query related events from the database up to that version and use them to restore the <em>Account</em>. If using a version to query the data is not your cup of tea, you could use a <em>Timestamp </em>from your event store instead.</p><p>That's it! That's all there is! Well… not really… but by now, you should have a decent understanding and know where to start!</p><h2 class="wp-block-heading">Event Sourcing Is Not All Fun And Games</h2><p>The Event Sourcing pattern has many good parts and some bad ones. If you think you need Event Sourcing , please read on.</p><p>Most developers are not familiar enough with the Event Sourcing concept. Explaining Event Sourcing to less experienced colleagues takes a lot of time. Moreover, explaining only Event Sourcing is usually not enough. DDD, CQRS, and the <a href="https://en.wikipedia.org/wiki/Eventual_consistency" target="_blank" rel="nofollow noopener noreferrer">eventual consistency model</a> model often go hand in hand with Event Sourcing. It's a very steep learning curve!</p><p>Most of the domains are not that complex. There, I said it. Event sourcing, on the other hand, is very complex. You have to consider snapshotting algorithms, being unable to change the data in the database in case there's an urgent production issue, handling event schema changes, and that's just the tip of the iceberg. Using Event Sourcing for a simple CRUD-based application is like using a chainsaw instead of a butter knife to make a sandwich — they both cut things, but one is a bit overkill. I will let you decide which one. </p><p>Even though the Event Sourcing pattern is excellent, you must thoroughly consider whether it's worth using it for your problem.</p><h2 class="wp-block-heading">Frequently Asked Questions</h2><p>Event Sourcing isn't as straightforward as it might seem at first. However, I find that some questions about it are asked more frequently than others.</p><h3 class="wp-block-heading">Does Event Sourcing hurt performance?</h3><p>If done well, Event Sourcing doesn't hurt performance. In fact, it's often quite the opposite since Event Sourcing usually comes together with the CQRS pattern, which solves many performance issues. Of course, there are cases where aggregates tend to have long and complex lifetimes (having many events), making the querying part very slow, but that's solvable with <a href="https://eventstore.com/docs/event-sourcing-basics/rolling-snapshots/index.html" target="_blank" rel="nofollow noopener noreferrer">snapshots</a>.</p><h3 class="wp-block-heading">What's the difference between domain and integrational events?</h3><p>People often split events into two categories — integration and domain, especially when working with microservices-based architecture. These categories are very similar since both events are state change notifications. However, their reasoning is different. Integration events notify other services about the state changes inside your service. Therefore, they rarely change and might contain additional information that domain events don't. Domain events notify aggregates inside your domain boundaries (and restore the state in Event Sourcing). Therefore, they can be changed more easily and have only minimal relevant information.</p><h3 class="wp-block-heading">What data stores can I use to implement an event store?</h3><p>We can implement an event store using <a href="https://www.microsoft.com/en-us/sql-server/" target="_blank" rel="nofollow noopener noreferrer">SQL Server</a>, <a href="https://www.mysql.com/" target="_blank" rel="nofollow noopener noreferrer">MySQL</a>, Cassandra, Event Store, and many other data stores. We should be able to query events in the same order we produced them for a specified aggregate ID, save events atomically, and utilize snapshotting. Other event store capabilities are mostly related to functional and non-functional application requirements. It's worth mentioning that many debates on the internet discuss whether we could use streaming platforms such as <a href="https://kafka.apache.org/" target="_blank" rel="nofollow noopener noreferrer">Kafka</a> to implement an event store. I've seen it work for specific business problems where there wasn't much data stored, and heavy in-memory caching was used. However, in most cases, you're better off with a different data store since you would likely need to query events for a specified aggregate ID in a reasonable amount of time.</p><h3 class="wp-block-heading">Can I update stored events?</h3><p>One day, our event schemas are inevitably going to change. Therefore, it's crucial to consider dealing with it beforehand. It becomes very tempting to change the stored data when the inevitable happens. However, most of the time, we shouldn't. By doing that, we're messing with historical data, which eliminates any guarantees of the data's authenticity and makes it less accurate. Instead, we should version our event schemas. Event schema versioning allows us to adjust the code according to new business requirements while keeping the stored data unchanged. We could hide the mapping between old and new schemas somewhere in the infrastructure layer of our application.</p><h3 class="wp-block-heading">Can I use Event Sourcing without CQRS?</h3><p>While using Event Sourcing without CQRS is possible, it's often not very practical. We usually need to query data from multiple aggregates combined. Moreover, building custom query models by subscribing to produced events is relatively simple. Combining Event Sourcing and CQRS is like a pair of socks—you could go with one sock instead of two, but why on earth would you do that?</p><figure class="post__image post__image--wide"><img loading="lazy" src="./../media/posts/9/one-sock-two-feet.webp" alt="One sock." width="1915" height="1149" sizes="(min-width: 760px) 660px, calc(93.18vw - 30px)" srcset="./../media/posts/9/responsive/one-sock-two-feet-xs.webp 320w, ./../media/posts/9/responsive/one-sock-two-feet-sm.webp 480w, ./../media/posts/9/responsive/one-sock-two-feet-md.webp 768w, ./../media/posts/9/responsive/one-sock-two-feet-xl.webp 1024w"></figure><h2 class="wp-block-heading">Resources</h2><p>If you're interested in learning more about Event Sourcing, here are some of the best resources you should start with.</p><h4 class="wp-block-heading"><a href="http://cqrsjourney.github.io/" target="_blank" rel="nofollow noopener noreferrer">Exploring CQRS and Event Sourcing: A journey into high scalability, availability, and maintainability with Windows Azure</a></h4><p>I can't stress enough how good this book is! This free e-book is hands down the single best Event Sourcing resource available right now. It covers a team's journey to CQRS and Event Sourcing in a detailed fashion with plenty of code examples and explanations of every decision. All of the code used in the book is available on GitHub.</p><h4 class="wp-block-heading"><a href="https://www.eventstorming.com/" target="_blank" rel="nofollow noopener noreferrer">Event Storming</a></h4><p>Event Storming and Event Sourcing are entirely different. However, they work exceptionally well together. Using the Event Storming method, we model our business domain on a whiteboard in aggregates, commands, and events. We can easily transform the whiteboard model into the source code if done right.</p><h4 class="wp-block-heading"><a href="https://github.com/gregoryyoung/m-r" target="_blank" rel="nofollow noopener noreferrer">Simple CQRS</a></h4><p>Simple CQRS is a sample project created by Greg Young to illustrate CQRS and Event Sourcing patterns. While the code is not quite production-ready, the complexity is extremely low, making it an excellent example for beginners. </p><h4 class="wp-block-heading"><a href="https://github.com/tautvydasversockas/cqrs-eventsourcing" target="_blank" rel="noopener noreferrer">CQRS &amp; EventSourcing</a></h4><p>CQRS &amp; EventSourcing is a sample project I created to illustrate CQRS and Event Sourcing patterns. The implementation is slightly more complex than Simple CQRS. However, it uses EventSoreDB and MySQL databases and is somewhat closer to what you might see in the production environment. I recommend running the project and playing around to get the feel of Event Sourcing.</p><h4 class="wp-block-heading"><a href="https://www.youtube.com/watch?v=MHvr71T_LZw" target="_blank" rel="nofollow noopener noreferrer">Domain-Driven Design, Event Sourcing and CQRS with F# and EventStore</a></h4><p>If you're not a big fan of <a href="https://en.wikipedia.org/wiki/Object-oriented_programming" target="_blank" rel="nofollow noopener noreferrer">OOP</a>, you might enjoy trying the pattern in a functional language such as F#.</p><h2 class="wp-block-heading">Final Words</h2><p>To use or not to use Event Sourcing, that is the question. The Event Sourcing pattern brings more complexity than the classic "store the current state" approach. On the other hand, it tends to bring many fantastic benefits such as performance gain, restoring the past states of your application, doing state rollbacks, and, most importantly, telling exactly what happened when things go south. If used in the right place at the right time, Event Sourcing will be your best friend that you wish you had met sooner.</p><hr><p><em>Thank you for reading. I'd love to hear about your experiences with Event Sourcing.</em></p></div><footer class="content__footer"><div class="content__share"><a href="https://www.facebook.com/sharer/sharer.php?u=%23PUBLII_RELATIVE_URL_BASE%23%2Fthe-promised-land-of-event-sourcing%2F" class="js-share facebook tltp tltp--top" aria-label="Facebook" rel="nofollow noopener noreferrer"><svg><use xlink:href="./../assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://twitter.com/intent/tweet?url=%23PUBLII_RELATIVE_URL_BASE%23%2Fthe-promised-land-of-event-sourcing%2F&amp;via=%40TheHonestCoder&amp;text=The%20Promised%20Land%20of%20Event%20Sourcing" class="js-share twitter tltp tltp--top" aria-label="Twitter" rel="nofollow noopener noreferrer"><svg><use xlink:href="./../assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=%23PUBLII_RELATIVE_URL_BASE%23%2Fthe-promised-land-of-event-sourcing%2F" class="js-share linkedin tltp tltp--top" aria-label="Share with LinkedIn" rel="nofollow noopener noreferrer"><svg><use xlink:href="./../assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span></a></div></footer></div></article><div class="content__section post__related"><div class="main__inner"><h3 class="content__section__title">Related post</h3><div class="post__related__wrap"><article class="c-card"><div class="c-card__meta"><div class="c-card__author"><a href="./../authors/tautvydas-versockas/">Tautvydas Versockas</a></div><time datetime="2022-02-20T12:00">Feb 20, 2022 </time><a href="./../tags/system-design/" class="c-card-tag">System Design</a></div><a href="./../redpanda-a-new-cool-kid-on-the-event-streaming-block/" class="c-card__image"><img src="./../media/posts/16/redpanda-featured.webp" srcset="./../media/posts/16/responsive/redpanda-featured-xs.webp 320w, ./../media/posts/16/responsive/redpanda-featured-sm.webp 480w" sizes="(min-width: 700px) 200px, (min-width: 480px) 160px, calc(100vw - 50px)" loading="lazy" height="864" width="1441" alt="Redpanda logo."></a><header class="c-card__header"><h2 class="c-card__title"><a href="./../redpanda-a-new-cool-kid-on-the-event-streaming-block/">Redpanda - A New Cool Kid on the Event Streaming Block</a></h2><p>Redpanda - ZooKeeper-free, JVM-free, Kafka compatible, and up to 10 times faster than Kafka. What's not to like!</p></header></article></div></div></div><div class="content__section banner"><div class="main__inner"><script src="https://giscus.app/client.js" data-repo="tautvydasversockas/thehonestcoder-discussions" data-repo-id="R_kgDOL-IysQ" data-category="Announcements" data-category-id="DIC_kwDOL-Iysc4CffdA" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en" data-loading="lazy" crossorigin="anonymous" async></script></div></div></main><div class="right-bar"><div class="right-bar__inner"><div class="sidebar"><section class="box personal-picture"><a href="./../about" class="personal-picture__image"><img src="./../media/files/cropped-me.webp"></a></section><section class="box buymeacoffee"><a href="https://www.buymeacoffee.com/tautvydasverso" target="_blank"><img align="left" src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" height="50" width="210" alt="tautvydasverso"></a></section><section class="box tags"><h3 class="box__title">Recommended Topics</h3><ul class="tags__list"><li class="tags__item"><a href="./../tags/net/" class="btn btn--gray">.NET</a></li><li class="tags__item"><a href="./../tags/databases/" class="btn btn--gray">Databases</a></li><li class="tags__item"><a href="./../tags/fun/" class="btn btn--gray">Fun</a></li><li class="tags__item"><a href="./../tags/life/" class="btn btn--gray">Life</a></li><li class="tags__item"><a href="./../tags/system-design/" class="btn btn--gray">System Design</a></li><li class="tags__item"><a href="./../tags/technical-leadership/" class="btn btn--gray">Technical Leadership</a></li></ul></section><div class="box follow"><a href="https://github.com/tautvydasversockas" class="tltp tltp--top" target="_blank" aria-label="GitHub"><svg><use xlink:href="./../assets/svg/svg-map.svg#github"/></svg> </a><a href="https://x.com/TheHonestCoder" class="tltp tltp--top" target="_blank" aria-label="Twitter"><svg><use xlink:href="./../assets/svg/svg-map.svg#twitter"/></svg> </a><a href="https://www.linkedin.com/in/tautvydasversockas/" class="tltp tltp--top" target="_blank" aria-label="LinkedIn"><svg><use xlink:href="./../assets/svg/svg-map.svg#linkedin"/></svg></a></div><div class="box copyright">© 2025 Tautvydas Versockas</div></div></div></div></div><script defer="defer" src="./../assets/js/scripts.min.js?v=b2d91bcadbf5db401b76eb5bb3092eb7"></script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><script>'use strict'; document.addEventListener('DOMContentLoaded', function() { var obfElements = document.querySelectorAll('.obfuscated-email'); obfElements.forEach(function(elem) { var dataType = elem.getAttribute('data-type'); var encodedEmail = elem.getAttribute('data-email'); var user = elem.getAttribute('data-user'); var domain = elem.getAttribute('data-domain'); var decodedEmail = ''; if (user && domain) { decodedEmail = user.split('').reverse().join('') + '@' + domain.split('').reverse().join(''); } else if (encodedEmail) { const parts = encodedEmail.split('@'); if (parts.length === 2) { decodedEmail = parts[0].split('').reverse().join('') + '@' + parts[1].split('').reverse().join(''); } else { decodedEmail = encodedEmail; } } if (dataType === 'mailto') { var originalText = elem.textContent.trim(); var a = document.createElement('a'); a.href = 'mailto:' + decodedEmail; if (elem.classList.length > 0) { a.className = elem.className; } if (originalText === '') { a.textContent = decodedEmail; } else { a.textContent = originalText; } elem.parentNode.replaceChild(a, elem); } else if (dataType === 'text') { var textNode = document.createTextNode(decodedEmail); elem.parentNode.replaceChild(textNode, elem); } }); });</script><script type="text/javascript">document.addEventListener("DOMContentLoaded", function() {
            if (window.location.pathname !== '/') {
                function calculateReadingTime() {
                    let totalWords = 0;

                    const textElements = document.querySelectorAll('.content__entry p');
                    textElements.forEach(element => {
                        totalWords += element.innerText.split(' ').filter(Boolean).length;
                    });

                    const headerElements = document.querySelectorAll('.content__entry .wp-block-heading');
                    headerElements.forEach(element => {
                        totalWords += element.innerText.split(' ').filter(Boolean).length;
                    });

                    const codeElements = document.querySelectorAll('.content__entry pre code');
                    codeElements.forEach(element => {
                        totalWords += element.innerText.split(' ').filter(Boolean).length;
                    });

                    const wordsPerMinute = 200;
                    const readingTimeDecimal = totalWords / wordsPerMinute;
                    const readingTimeMinutes = Math.floor(readingTimeDecimal);
                    const fractionalMinute = readingTimeDecimal - readingTimeMinutes;
                    const readingTimeSeconds = Math.round(fractionalMinute * 60);
                    const timeString = readingTimeMinutes + (readingTimeSeconds > 29 ? 1 :0);
                    const finalText = '%s min read'.replace('%s', timeString);

                    const readingTimeElement = document.createElement('div');
                    readingTimeElement.className = 'reading-time';                
                    readingTimeElement.textContent = finalText;
                    const targetElement = document.querySelector('.date-meta-separator');
                    if (targetElement) 
                        targetElement.insertAdjacentElement('afterend', readingTimeElement);
                }
                calculateReadingTime();
            }            
        });</script><script defer="defer" src="./../media/plugins/syntaxHighlighter/prism.js"></script><script defer="defer" src="./../media/plugins/syntaxHighlighter/clipboard.min.js"></script><script defer="defer" src="./../media/plugins/syntaxHighlighter/prism-copy-to-clipboard.min.js"></script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">We use cookies to enhance your browsing experience and analyze our traffic.</div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--link pcb__btn--configure" aria-haspopup="dialog">Manage preferences</button> <button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><div class="pcb__popup" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-popup-title"><div class="pcb__popup__wrapper"><div class="pcb__inner pcb__popup__inner"><div class="pcb__popup__heading"><div id="pcb-popup-title" role="heading" aria-level="2" class="pcb__title">Cookie settings</div><button class="pcb__popup__close" aria-label="Close"></button></div><div class="pcb__popup__content"><div class="pcb__txt pcb__popup__txt">We use cookies to enhance your browsing experience and analyze our traffic. By clicking "Accept All", you consent to our use of cookies.</div><ul class="pcb__groups"><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Google</summary></details><div class="pcb__popup__switch"><input type="checkbox" data-group-name="Google" id="Google-cookies"> <label for="Google-cookies">Google</label></div></li></ul></div><div class="pcb__buttons pcb__popup__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button> <button type="button" class="pcb__btn pcb__btn--reject"></button> <button type="button" class="pcb__btn pcb__btn--save">Save settings</button></div></div></div></div><div class="pcb__overlay" aria-hidden="true"></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('🍪 Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('🍪 Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('🍪 Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && cbConfig.initialLsState.indexOf(allowedGroup) === -1) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('🍪 GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('🍪 Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('🍪 Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>