<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Domain-Driven Design With Entity Framework Core 8 - The Honest Coder</title><meta name="description" content="Learn to implement Domain-Driven Design patterns using Entity Framework Core 8!"><meta name="generator" content="Publii Open-Source CMS for Static Site"><script type="gdpr-blocker/analytics" async src="https://www.googletagmanager.com/gtag/js?id=G-P87PBR2D4P"></script><script type="gdpr-blocker/analytics">window.dataLayer = window.dataLayer || [];
				  function gtag(){dataLayer.push(arguments);}
				  gtag('js', new Date());
				  gtag('config', 'G-P87PBR2D4P' );</script><link rel="stylesheet" href="https://thehonestcoder.com/media/plugins/syntaxHighlighter/prism-black.css"><link rel="canonical" href="https://thehonestcoder.com/ddd-ef-core-8/"><link rel="alternate" type="application/atom+xml" href="https://thehonestcoder.com/feed.xml" title="The Honest Coder - RSS"><link rel="alternate" type="application/json" href="https://thehonestcoder.com/feed.json" title="The Honest Coder - JSON"><meta property="og:title" content="Domain-Driven Design With Entity Framework Core 8"><meta property="og:image" content="https://thehonestcoder.com/media/posts/6/ddd-ef-core-featured.webp"><meta property="og:image:width" content="1364"><meta property="og:image:height" content="818"><meta property="og:site_name" content="The Honest Coder"><meta property="og:description" content="Learn to implement Domain-Driven Design patterns using Entity Framework Core 8!"><meta property="og:url" content="https://thehonestcoder.com/ddd-ef-core-8/"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@TheHonestCoder"><meta name="twitter:title" content="Domain-Driven Design With Entity Framework Core 8"><meta name="twitter:description" content="Learn to implement Domain-Driven Design patterns using Entity Framework Core 8!"><meta name="twitter:image" content="https://thehonestcoder.com/media/posts/6/ddd-ef-core-featured.webp"><link rel="shortcut icon" href="https://thehonestcoder.com/media/website/logo-v3.webp" type="image/x-icon"><link rel="preload" href="https://thehonestcoder.com/assets/dynamic/fonts/publicsans/publicsans.woff2" as="font" type="font/woff2" crossorigin><link rel="stylesheet" href="https://thehonestcoder.com/assets/css/style.css?v=30c72d59656faab72e55eb4b4a720e22"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://thehonestcoder.com/ddd-ef-core-8/"},"headline":"Domain-Driven Design With Entity Framework Core 8","datePublished":"2023-12-17T12:00+02:00","dateModified":"2025-08-26T10:58+03:00","image":{"@type":"ImageObject","url":"https://thehonestcoder.com/media/posts/6/ddd-ef-core-featured.webp","height":818,"width":1364},"description":"Learn to implement Domain-Driven Design patterns using Entity Framework Core 8!","author":{"@type":"Person","name":"Tautvydas Versockas","url":"https://thehonestcoder.com/authors/tautvydas-versockas/"},"publisher":{"@type":"Organization","name":"Tautvydas Versockas","logo":{"@type":"ImageObject","url":"https://thehonestcoder.com/media/website/logo-v3-2.webp","height":500,"width":500}}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="post-template"><div class="container"><div class="left-bar"><div class="left-bar__inner"><header class="header"><a class="logo" href="https://thehonestcoder.com/"><img src="https://thehonestcoder.com/media/website/logo-v3-2.webp" alt="The Honest Coder" width="500" height="500"></a><nav class="navbar"><button class="navbar__toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle__box"><span class="navbar__toggle__inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://thehonestcoder.com/" target="_self" aria-label="Home"><span>Home</span></a></li><li><a href="https://thehonestcoder.com/about/" target="_self" aria-label="About me"><span>About me</span></a></li><li><a href="https://thehonestcoder.com/speaking/" target="_self" aria-label="Speaking"><span>Speaking</span></a></li></ul></nav><a class="logo logo--atbottom" href="https://thehonestcoder.com/"><img src="https://thehonestcoder.com/media/website/logo-v3-2.webp" alt="The Honest Coder" width="500" height="500"></a></header></div></div><main class="main post"><article class="content"><figure class="content__featured-image content__featured-image--attop"><img src="https://thehonestcoder.com/media/posts/6/ddd-ef-core-featured.webp" srcset="https://thehonestcoder.com/media/posts/6/responsive/ddd-ef-core-featured-xs.webp 320w, https://thehonestcoder.com/media/posts/6/responsive/ddd-ef-core-featured-sm.webp 480w, https://thehonestcoder.com/media/posts/6/responsive/ddd-ef-core-featured-md.webp 768w, https://thehonestcoder.com/media/posts/6/responsive/ddd-ef-core-featured-xl.webp 1024w" sizes="(min-width: 1460px) 938px, (min-width: 1200px) calc(75.83vw - 154px), (min-width: 1120px) 938px, (min-width: 900px) calc(55vw + 333px), 100vw" loading="eager" height="818" width="1364" alt="Spider-Man reading &quot;Domain-Driven Design: Tackling Complexity in Heart of Software&quot; by Eric Evans." aria-describedby="image-caption"></figure><div class="main__inner"><div class="content__meta"><div class="content__date"><time datetime="2023-12-17T12:00">Dec 17, 2023</time></div><span class="meta-separator date-meta-separator">â€¢</span> <span class="meta-separator reading-time-meta-separator">â€¢</span><div class="content__maintag"><a href="https://thehonestcoder.com/tags/system-design/" class="metadata__maintag">System Design</a></div></div><header class="content__header"><h1 class="content__title">Domain-Driven Design With Entity Framework Core 8</h1></header><div class="content__entry"><p>Domain-Driven Design (DDD) is a collection of principles and patterns that helps developers build software by modeling business domains. In other words, it's all about understanding your business and transforming it into the code. Writing code is, dare I say it, the easiest part of DDD. Yet, storing your sophisticated domain models in a database can sometimes get tricky. In this article, I will show you how to use various DDD patterns together with <a href="https://learn.microsoft.com/en-us/ef/core/" target="_blank" rel="nofollow noopener noreferrer">Entity Framework (EF) Core 8</a>. I will be using Microsoft SQL Server as a database. However, the code examples (with minor adjustments) should also work with other relational databases such as MySQL or PostgreSQL.</p><h2 class="wp-block-heading">Creating Entities</h2><p>Entities in Domain-Driven Design are domain objects defined by their identities and lifecycles. In simpler terms, they represent unique domain objects that can change over time. Let's define two of them - aÂ <em>Product</em>Â and aÂ <em>Seller</em>Â that sells products:</p><pre class="language-csharp"><code>public sealed class Product
{
    public Guid Id { get; }
    public Guid SellerId { get; }
    public string Name { get; }
    public string Currency { get; }
    public decimal Price { get; }

    private Product() { }

    public Product(
        Guid id,
        Seller seller,
        string name,
        string currency,
        decimal price) : this()
    {
        Id = id;
        SellerId = seller.Id;
        Name = name;
        Currency = currency;
        Price = price;
    }
}

public sealed class Seller
{
    public Guid Id { get; }
    public string Name { get; }

    public Seller(
        Guid id,
        string name)
    {
        Id = id;
        Name = name;
    }
}</code></pre><p>Notice the empty private constructor in theÂ <em>Product</em>Â entity. EF can use either a constructor with properties matching arguments (i.e.Â <em>Seller</em>) or an empty constructor and then resolve all entity properties using .NET reflection. It doesn't matter whether constructors are public, private, or internal. That means we can create many different constructors with all kinds of arguments. I usually go with an empty private constructor for EF and a public one for the rest of the application. It might not be super clean, as I'm leaking infrastructure concerns into my domain model. However, it's a pragmatic approach as it reduces boilerplate code while not impacting the domain model in a significant way.</p><p>Let's addÂ <em>Microsoft.EntityFrameworkCore.SqlServer</em>Â library and define EF database context together with our entity configurations:</p><pre class="language-csharp"><code>using Microsoft.EntityFrameworkCore;

public sealed class MyDbContext : DbContext
{
    private readonly string _connectionString;

    public MyDbContext(string connectionString)
    {
        _connectionString = connectionString;
    }

    public DbSet&lt;Product&gt; Products =&gt; Set&lt;Product&gt;();
    public DbSet&lt;Seller&gt; Sellers =&gt; Set&lt;Seller&gt;();

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        optionsBuilder.UseSqlServer(_connectionString);
    }
    
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity&lt;Product&gt;(b =&gt; 
        {
            b.HasKey(x =&gt; x.Id);

            b.Property(x =&gt; x.Name)
                .HasMaxLength(100);

            b.Property(x =&gt; x.Currency)
                .HasMaxLength(3);

            b.Property(x =&gt; x.Price);

            b.HasOne&lt;Seller&gt;()
                .WithMany()
                .HasForeignKey(x =&gt; x.SellerId);
        });

        modelBuilder.Entity&lt;Seller&gt;(b =&gt; 
        {
            b.HasKey(x =&gt; x.Id);

            b.Property(x =&gt; x.Name)
                .HasMaxLength(100);
        });
    }
}</code></pre><p>After <a href="https://learn.microsoft.com/en-us/ef/core/get-started/overview/first-app?tabs=netcore-cli" target="_blank" rel="nofollow noopener noreferrer">generating migrations and updating our database</a>, we should now be able to work withÂ <em>Product</em>Â andÂ <em>Seller</em>Â entities:</p><pre class="language-csharp"><code>using Microsoft.EntityFrameworkCore;

const string connectionString = "Server=localhost;Database=MyDatabase;Trusted_Connection=True;";

var sellerId = Guid.NewGuid();

await using (var ctx = new MyDbContext(connectionString))
{
    var seller = new Seller(sellerId, "Seller");
    ctx.Sellers.Add(seller);

    var product = new Product(Guid.NewGuid(), seller, "Product", "EUR", 100);
    ctx.Products.Add(product);

    await ctx.SaveChangesAsync();
}

await using (var ctx = new MyDbContext(connectionString))
{
    var sellers = await ctx.Sellers.ToListAsync();
    var products = await ctx.Products.ToListAsync();
}</code></pre><p>Easy, right? Not so fast! Let's go one step further and introduce value objects.</p><h2 class="wp-block-heading">Mapping Value Objects</h2><p>Value objects in Domain-Driven Design are immutable stateless domain objects defined only by their property values. Let's define a couple of them:</p><pre class="language-csharp"><code>public sealed class ProductId
{
    public Guid Value { get; }

    public ProductId(Guid value)
    {
        Value = value;
    }
}

public sealed class ProductName
{
    public const int MaxLength = 100;

    public string Value { get; }

    public ProductName(string value)
    {
        if (value.Length is 0 or &gt; MaxLength)
            throw new ArgumentException($"Length must be between 1 and {MaxLength}.", nameof(value));

        Value = value;
    }
}

public sealed class Money
{
    public Currency Currency { get; }
    public decimal Amount { get; }

    public Money(Currency currency, decimal amount)
    {
        Currency = currency;

        if (amount &lt; 0)
            throw new ArgumentException("Amount can't be negative.", nameof(amount));

        Amount = amount;
    }
}

public sealed class Currency
{
    public const int Length = 100;

    public static readonly Currency USD = new("USD");
    public static readonly Currency EUR = new("EUR");

    public string Value { get; }

    private Currency(string value)
    {
        if (value.Length is not Length)
            throw new ArgumentException($"Length must be {Length}.", nameof(value));

        Value = value;
    }
}</code></pre><p>Since we validate data when creating value objects, we can be sure that our database will have valid data after value objects are persisted. There's no need to repeat validations when restoring persisted value objects. It can even be problematic if we do so, especially after introducing new validation rules that have yet to be applied to the whole database. To mitigate this, we could introduce a static factory method:</p><pre class="language-csharp"><code>public sealed class ProductName
{
    public const int MaxLength = 100;

    public string Value { get; }

    private ProductName(string value)
    {
        Value = value;
    }

    public static ProductName Create(string value)
    {
        if (value.Length is 0 or &gt; MaxLength)
            throw new ArgumentException($"Length must be between 1 and {MaxLength}.", nameof(value));

        return new ProductName(value);
    }
}</code></pre><p>We could then use .NET reflection to configure EF to use private value object constructors when restoring persisted value objects. However, to ensure the code examples are not overly complicated, we'll stick with one public constructor for the rest of this article.</p><p>We should also override equality operators, as two or more value objects are equal if they have the same property values (entities, on the other hand, are equal if they have identical IDs). We could use either the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.object.equals?view=net-8.0" target="_blank" rel="nofollow noopener noreferrer">standard .NET method</a> or one of my go-to open-source libraries, <a href="https://learn.microsoft.com/en-us/dotnet/api/system.object.equals?view=net-8.0" target="_blank" rel="nofollow noopener noreferrer">CSharpFunctionalExtensions</a>. This library provides base classes for value objects and entities, significantly reducing boilerplate code.</p><p>After implementing the changes mentioned above, our value objects should look like this:</p><pre class="language-csharp"><code>using CSharpFunctionalExtensions;

public sealed class ProductId : ValueObject
{
    public Guid Value { get; }

    public ProductId(Guid value)
    {
        Value = value;
    }

    protected override IEnumerable&lt;IComparable&gt; GetEqualityComponents()
    {
        yield return Value;
    }
}

public sealed class ProductName : ValueObject
{
    public const int MaxLength = 100;

    public string Value { get; }

    public ProductName(string value)
    {
        if (value.Length is 0 or &gt; MaxLength)
            throw new ArgumentException($"Length must be between 1 and {MaxLength}.", nameof(value));

        Value = value;
    }

    protected override IEnumerable&lt;IComparable&gt; GetEqualityComponents()
    {
        yield return Value;
    }
}

public sealed class Money : ValueObject
{
    public Currency Currency { get; }
    public decimal Amount { get; }

    public Money(Currency currency, decimal amount)
    {
        Currency = currency;

        if (amount &lt; 0)
            throw new ArgumentException("Amount can't be negative.", nameof(amount));

        Amount = amount;
    }

    protected override IEnumerable&lt;IComparable&gt; GetEqualityComponents()
    {
        yield return Currency;
        yield return Amount;
    }
}

public sealed class Currency : ValueObject
{
    public const int Length = 100;

    public static readonly Currency USD = new("USD");
    public static readonly Currency EUR = new("EUR");

    public string Value { get; }

    public Currency(string value)
    {
        if (value.Length is not Length)
            throw new ArgumentException($"Length must be {Length}.", nameof(value));

        Value = value;
    }

    protected override IEnumerable&lt;IComparable&gt; GetEqualityComponents()
    {
        yield return Value;
    }
}</code></pre><p>Let's also change our entities accordingly:</p><pre class="language-csharp"><code>using CSharpFunctionalExtensions;

public sealed class Product : Entity&lt;ProductId&gt;
{
    public SellerId SellerId { get; }
    public ProductName Name { get; }
    public Money Price { get; }

    private Product() { }

    public Product(
        ProductId id,
        Seller seller,
        ProductName name,
        Money price) : this()
    {
        Id = id;
        SellerId = seller.Id;
        Name = name;
        Price = price;
    }
}

public sealed class Seller : Entity&lt;SellerId&gt;
{
    public SellerName Name { get; }

    public Seller(
        SellerId id,
        SellerName name)
    {
        Id = id;
        Name = name;
    }
}</code></pre><p>Let's update our database context:</p><pre class="language-csharp"><code>modelBuilder.Entity&lt;Product&gt;(b =&gt;
{
    b.HasKey(x =&gt; x.Id);

    b.Property(x =&gt; x.Id)
        .HasConversion(x =&gt; x.Value, x =&gt; new ProductId(x));

    b.Property(x =&gt; x.Name)
        .HasConversion(x =&gt; x.Value, x =&gt; new ProductName(x))
        .HasMaxLength(ProductName.MaxLength);

    b.OwnsOne(
        x =&gt; x.Price,
        b =&gt;
        {
            b.Property(x =&gt; x.Currency)
                .HasConversion(x =&gt; x.Value, x =&gt; new Currency(x))
                .HasMaxLength(Currency.Length);

            b.Property(x =&gt; x.Amount);
        });

    b.HasOne&lt;Seller&gt;()
        .WithMany()
        .HasForeignKey(x =&gt; x.SellerId);
});

modelBuilder.Entity&lt;Seller&gt;(b =&gt;
{
    b.HasKey(x =&gt; x.Id);

    b.Property(x =&gt; x.Id)
        .HasConversion(x =&gt; x.Value, x =&gt; new SellerId(x));

    b.Property(x =&gt; x.Name)
        .HasConversion(x =&gt; x.Value, x =&gt; new ProductName(x))
        .HasMaxLength(SellerName.MaxLength);
});</code></pre><p>Alternatively, for value objects, we could use complex properties introduced in EF Core 8:</p><pre class="language-csharp"><code>b.ComplexProperty(
    x =&gt; x.Price,
    b =&gt;
    {
        b.ComplexProperty(
            x =&gt; x.Currency,
            b =&gt;
            {
                b.Property(x =&gt; x.Value)
                    .HasColumnName($"{nameof(Product.Price)}_{nameof(Money.Currency)}")
                    .HasMaxLength(Currency.Length);
            });

        b.Property(x =&gt; x.Amount);
    });</code></pre><p>In theory, it's better to use EF complex properties - configuring value objects as owned entities will prevent us from reusing those value objects in different entities. In practice, however, EF complex properties still have many limitations, one of which is <a href="https://github.com/dotnet/efcore/issues/31376" target="_blank" rel="nofollow noopener noreferrer">not supporting null values</a>. I guess most of the missing features will be implemented in EF Core 9, as many limitations were not deliberate design decisions.</p><figure class="post__image post__image--wide"><img loading="lazy" src="https://thehonestcoder.com/media/posts/6/ef-core-8-optional-complex-types.png" alt="EF Core library maintainer discussing optional complex types in EF Core 8." width="1000" height="434" sizes="(min-width: 760px) 660px, calc(93.18vw - 30px)" srcset="https://thehonestcoder.com/media/posts/6/responsive/ef-core-8-optional-complex-types-xs.png 320w, https://thehonestcoder.com/media/posts/6/responsive/ef-core-8-optional-complex-types-sm.png 480w, https://thehonestcoder.com/media/posts/6/responsive/ef-core-8-optional-complex-types-md.png 768w, https://thehonestcoder.com/media/posts/6/responsive/ef-core-8-optional-complex-types-xl.png 1024w"><figcaption>EF Core library maintainer discussing optional complex types in EF Core 8.</figcaption></figure><h2 class="wp-block-heading">Storing Value Object Collections</h2><p>Let's extend our domain model further by adding a collection ofÂ <em>SocialMediaLinkÂ </em>value objects to theÂ <em>Seller</em> entity:</p><pre class="language-csharp"><code>using CSharpFunctionalExtensions;

public sealed class Seller : Entity&lt;SellerId&gt;
{
    public SellerName Name { get; }

    private readonly List&lt;SocialMediaLink&gt; _socialMediaLinks;
    public IReadOnlyList&lt;SocialMediaLink&gt; SocialMediaLinks =&gt; _socialMediaLinks;

    private Seller() { }

    public Seller(
        SellerId id,
        SellerName name) : this()
    {
        Id = id;
        Name = name;
        _socialMediaLinks = [];
    }

    public void AddSocialMediaLink(SocialMediaLink link)
    {
        if (_socialMediaLinks.Contains(link))
            return;

        _socialMediaLinks.Add(link);
    }
}

public sealed class SocialMediaLink : ValueObject
{
    public const int MaxSocialNetworkLength = 20;
    public const int MaxHandleLength = 20;

    public static SocialMediaLink Facebook(string handle) =&gt; new("Facebook", handle);
    public static SocialMediaLink Instagram(string handle) =&gt; new("Instagram", handle);

    public string SocialNetwork { get; }
    public string Handle { get; }

    public SocialMediaLink(string socialNetwork, string handle)
    {
        if (socialNetwork.Length is 0 or &gt; MaxSocialNetworkLength)
            throw new ArgumentException($"Length must be between 1 and {MaxSocialNetworkLength}.", nameof(socialNetwork));

        SocialNetwork = socialNetwork;

        if (handle.Length is 0 or &gt; MaxHandleLength)
            throw new ArgumentException($"Length must be between 1 and {MaxSocialNetworkLength}.", nameof(handle));

        Handle = handle;
    }

    protected override IEnumerable&lt;IComparable&gt; GetEqualityComponents()
    {
        yield return SocialNetwork;
        yield return Handle;
    }
}</code></pre><p>Before EF Core 8, we could use custom EF value converters serializing value object collections to a text value (i.e. JSON) or map them to separate database tables. Fortunately, EF Core 8 supports mapping value object collections to JSON without having custom value converters. Moreover, it allows data to be filtered by serialized value object properties. Let's update our database context:</p><pre class="language-csharp"><code>modelBuilder.Entity&lt;Seller&gt;(b =&gt;
{
    // ...

    b.OwnsMany(
        x =&gt; x.SocialMediaLinks,
        b =&gt;
        {
            b.Property(x =&gt; x.SocialNetwork);

            b.Property(x =&gt; x.Handle);

            b.ToJson();
        });
});</code></pre><h2 class="wp-block-heading">Introducing Aggregates</h2><p>An aggregate in Domain-Driven Design is a cluster of entities treated as a single unit. One of those entities is called an aggregate root. An aggregate root ensures the integrity of the whole aggregate, as all of the modifications to the aggregate entities should only go through the aggregate root. Let's create aÂ <em>Store</em>Â entity and add it to theÂ <em>Seller</em>Â aggregate. EntityÂ <em>Seller</em>Â will become an aggregate root:</p><pre class="language-csharp"><code>public sealed class Seller : Entity&lt;SellerId&gt;
{
    public SellerName Name { get; }

    private readonly List&lt;SocialMediaLink&gt; _socialMediaLinks;
    public IReadOnlyList&lt;SocialMediaLink&gt; SocialMediaLinks =&gt; _socialMediaLinks;

    private readonly List&lt;Store&gt; _stores;
    public IReadOnlyList&lt;Store&gt; Stores =&gt; _stores;

    private Seller() { }

    public Seller(
        SellerId id,
        SellerName name) : this()
    {
        Id = id;
        Name = name;
        _socialMediaLinks = [];
        _stores = [];
    }

    public void AddSocialMediaLink(SocialMediaLink link)
    {
        if (_socialMediaLinks.Contains(link))
            return;

        _socialMediaLinks.Add(link);
    }

    public void AddStore(StoreId id, Hour openFrom, Hour openTo)
    {
        var store = new Store(id, Id, openFrom, openTo);

        if (_stores.Contains(store))
            return;

        _stores.Add(store);
    }
}

public sealed class Store : Entity&lt;StoreId&gt;
{
    public SellerId SellerId { get; }
    public Hour OpenFrom { get; }
    public Hour OpenTo { get; }

    internal Store(
        StoreId id,
        SellerId sellerId,
        Hour openFrom,
        Hour openTo)
    {
        Id = id;
        SellerId = sellerId;
        OpenFrom = openFrom;
        OpenTo = openTo;
    }
}

public sealed class Hour : ValueObject
{
    public int Value { get; }

    public Hour(int value)
    {
        if (value is &lt; 0 or &gt; 24)
            throw new ArgumentException("Value must be between 0 and 24", nameof(value));

        Value = value;
    }

    protected override IEnumerable&lt;IComparable&gt; GetEqualityComponents()
    {
        yield return Value;
    }
}</code></pre><p>We could use EFÂ <em>OwnsMany</em>Â configuration, which would automatically loadÂ <em>Stores</em>Â when querying theÂ <em>Seller</em>:</p><pre class="language-csharp"><code>public sealed class MyDbContext : DbContext
{
    // ...

    public DbSet&lt;Product&gt; Products =&gt; Set&lt;Product&gt;();
    public DbSet&lt;Seller&gt; Sellers =&gt; Set&lt;Seller&gt;();

    // ...

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // ...

        modelBuilder.Entity&lt;Seller&gt;(b =&gt;
        {
            // ...

            b.OwnsMany(
                x =&gt; x.Stores,
                b =&gt;
                {
                    b.HasKey(x =&gt; x.Id);

                    b.Property(x =&gt; x.Id)
                        .HasConversion(x =&gt; x.Value, x =&gt; new StoreId(x));

                    b.Property(x =&gt; x.OpenFrom)
                        .HasConversion&lt;HourConverter&gt;();

                    b.Property(x =&gt; x.OpenTo)
                        .HasConversion&lt;HourConverter&gt;();

                    b.WithOwner()
                        .HasForeignKey(x =&gt; x.SellerId);
                });
        });
    }
}</code></pre><p>Notice theÂ <em>HourConverter</em> - instead of repeating the same conversion expression twice, we could define a separate reusable value converter:</p><pre class="language-csharp"><code>public sealed class HourConverter : ValueConverter&lt;Hour, int&gt;
{
    public HourConverter()
        : base(x =&gt; x.Value, x =&gt; new Hour(x)) { }
}</code></pre><p>As an alternative toÂ <em>OwnsMany</em>, we could use EF CoreÂ <em>HasMany</em> configuration. The downside of this approach is that we would need to include stores explicitly when querying sellers. However, this approach is more flexible, as we can query stores individually without querying sellers or query sellers without querying stores. This flexibility is valuable when working with large aggregates that take significant time to query. I usually prefer this approach, especially when using the repository pattern, as I can put all of the extra included statements inside of the repository:</p><pre class="language-csharp"><code>public sealed class MyDbContext : DbContext
{
    // ...

    public DbSet&lt;Product&gt; Products =&gt; Set&lt;Product&gt;();
    public DbSet&lt;Seller&gt; Sellers =&gt; Set&lt;Seller&gt;();
    public DbSet&lt;Store&gt; Stores =&gt; Set&lt;Store&gt;();

    // ...

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // ...

        modelBuilder.Entity&lt;Seller&gt;(b =&gt;
        {
            // ...

            b.HasMany(x =&gt; x.Stores)
                .WithOne()
                .HasForeignKey(x =&gt; x.SellerId);
        });

        modelBuilder.Entity&lt;Store&gt;(b =&gt;
        {
            b.HasKey(x =&gt; x.Id);

            b.Property(x =&gt; x.Id)
                .HasConversion(x =&gt; x.Value, x =&gt; new StoreId(x));

            b.Property(x =&gt; x.OpenFrom)
                .HasConversion&lt;HourConverter&gt;();

            b.Property(x =&gt; x.OpenTo)
                .HasConversion&lt;HourConverter&gt;();
        });
    }
}

public sealed class SellersRepository
{
    private readonly MyDbContext _ctx;

    public SellersRepository(MyDbContext ctx)
    {
        _ctx = ctx;
    }

    public Task&lt;Seller?&gt; GetById(SellerId id, CancellationToken token = default)
    {
        return _ctx.Sellers
            .Include(x =&gt; x.Stores)
            .FirstOrDefaultAsync(x =&gt; x.Id == id, token);
    }
}</code></pre><p>To map one-to-one relations instead of one-to-many (i.e.Â <em>Seller</em>Â with only oneÂ <em>Store</em>), you could use almost identicalÂ <em>HasOneÂ </em>andÂ <em>OwnsOneÂ </em>EF configurations.</p><h2 class="wp-block-heading">Summary</h2><p>Domain-driven design patterns and Entity Framework Core 8 are a very powerful combination. It only takes a couple of lines of code to map entities, value objects, and even aggregate roots to database tables. What is more, it gets better and better every release. I can only wonder what Entity Framework Core 9 will bring!</p><hr><p><em>Thank you for reading. Is there something else that this post needs to include? I'd love to hear about it in the comments.</em></p></div><footer class="content__footer"><div class="content__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fthehonestcoder.com%2Fddd-ef-core-8%2F" class="js-share facebook tltp tltp--top" aria-label="Facebook" rel="nofollow noopener noreferrer"><svg><use xlink:href="https://thehonestcoder.com/assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fthehonestcoder.com%2Fddd-ef-core-8%2F&amp;via=%40TheHonestCoder&amp;text=Domain-Driven%20Design%20With%20Entity%20Framework%20Core%208" class="js-share twitter tltp tltp--top" aria-label="Twitter" rel="nofollow noopener noreferrer"><svg><use xlink:href="https://thehonestcoder.com/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fthehonestcoder.com%2Fddd-ef-core-8%2F" class="js-share linkedin tltp tltp--top" aria-label="Share with LinkedIn" rel="nofollow noopener noreferrer"><svg><use xlink:href="https://thehonestcoder.com/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span></a></div></footer></div></article><div class="content__section post__related"><div class="main__inner"><h3 class="content__section__title">Related post</h3><div class="post__related__wrap"><article class="c-card"><div class="c-card__meta"><div class="c-card__author"><a href="https://thehonestcoder.com/authors/tautvydas-versockas/">Tautvydas Versockas</a></div><time datetime="2025-12-08T14:59">Dec 8, 2025 </time><a href="https://thehonestcoder.com/tags/system-design/" class="c-card-tag">System Design</a></div><a href="https://thehonestcoder.com/outbox-pattern-debezium-kafka/" class="c-card__image"><img src="https://thehonestcoder.com/media/posts/23/outbox-debesium-featured.png" srcset="https://thehonestcoder.com/media/posts/23/responsive/outbox-debesium-featured-xs.png 320w, https://thehonestcoder.com/media/posts/23/responsive/outbox-debesium-featured-sm.png 480w" sizes="(min-width: 700px) 200px, (min-width: 480px) 160px, calc(100vw - 50px)" loading="lazy" height="1640" width="2360" alt="PostgreSQL, Debezium, and Kafka."></a><header class="c-card__header"><h2 class="c-card__title"><a href="https://thehonestcoder.com/outbox-pattern-debezium-kafka/">Reliable Event Publishing: Outbox Pattern with PostgreSQL, Debezium, and Kafka</a></h2><p>Learn how to implement the Outbox pattern with PostgreSQL, Debezium, and Kafka (using Redpanda).</p></header></article><article class="c-card"><div class="c-card__meta"><div class="c-card__author"><a href="https://thehonestcoder.com/authors/tautvydas-versockas/">Tautvydas Versockas</a></div><time datetime="2021-07-14T12:00">Jul 14, 2021 </time><a href="https://thehonestcoder.com/tags/system-design/" class="c-card-tag">System Design</a></div><a href="https://thehonestcoder.com/service-leader-election-with-net-and-apache-zookeeper/" class="c-card__image"><img src="https://thehonestcoder.com/media/posts/15/zookeeper-featured.webp" srcset="https://thehonestcoder.com/media/posts/15/responsive/zookeeper-featured-xs.webp 320w, https://thehonestcoder.com/media/posts/15/responsive/zookeeper-featured-sm.webp 480w" sizes="(min-width: 700px) 200px, (min-width: 480px) 160px, calc(100vw - 50px)" loading="lazy" height="735" width="1225" alt="Apache ZooKeeper logo."></a><header class="c-card__header"><h2 class="c-card__title"><a href="https://thehonestcoder.com/service-leader-election-with-net-and-apache-zookeeper/">Service Leader Election With .NET and Apache ZooKeeper</a></h2><p>Building reliable distributed software solutions is not an easy task. However, it gets slightly easier using Apache ZooKeeper.</p></header></article><article class="c-card"><div class="c-card__meta"><div class="c-card__author"><a href="https://thehonestcoder.com/authors/tautvydas-versockas/">Tautvydas Versockas</a></div><time datetime="2020-09-09T12:00">Sep 9, 2020 </time><a href="https://thehonestcoder.com/tags/system-design/" class="c-card-tag">System Design</a></div><a href="https://thehonestcoder.com/retry-requests-fearlessly-with-idempotence/" class="c-card__image"><img src="https://thehonestcoder.com/media/posts/8/retry-requests-featured.webp" srcset="https://thehonestcoder.com/media/posts/8/responsive/retry-requests-featured-xs.webp 320w, https://thehonestcoder.com/media/posts/8/responsive/retry-requests-featured-sm.webp 480w" sizes="(min-width: 700px) 200px, (min-width: 480px) 160px, calc(100vw - 50px)" loading="lazy" height="1001" width="1668" alt="Faking Exactly-Once Delivery with Idempotence book."></a><header class="c-card__header"><h2 class="c-card__title"><a href="https://thehonestcoder.com/retry-requests-fearlessly-with-idempotence/">Retry Requests Fearlessly with Idempotence</a></h2><p>A practical guide to being fearless in the presence of duplicate service requests.</p></header></article></div></div></div><div class="content__section banner"><div class="main__inner"><script src="https://giscus.app/client.js" data-repo="tautvydasversockas/thehonestcoder-discussions" data-repo-id="R_kgDOL-IysQ" data-category="Announcements" data-category-id="DIC_kwDOL-Iysc4CffdA" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en" data-loading="lazy" crossorigin="anonymous" async></script></div></div></main><div class="right-bar"><div class="right-bar__inner"><div class="sidebar"><section class="box personal-picture"><a href="https://thehonestcoder.com/about" class="personal-picture__image"><img src="https://thehonestcoder.com/media/files/cropped-me.webp" alt="Tautvydas Versockas"></a></section><section class="box buymeacoffee"><a href="https://www.buymeacoffee.com/tautvydasverso" target="_blank"><img align="left" src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" height="50" width="210" alt="tautvydasverso"></a></section><section class="box tags"><h3 class="box__title">Recommended Topics</h3><ul class="tags__list"><li class="tags__item"><a href="https://thehonestcoder.com/tags/net/" class="btn btn--gray">.NET</a></li><li class="tags__item"><a href="https://thehonestcoder.com/tags/databases/" class="btn btn--gray">Databases</a></li><li class="tags__item"><a href="https://thehonestcoder.com/tags/fun/" class="btn btn--gray">Fun</a></li><li class="tags__item"><a href="https://thehonestcoder.com/tags/life/" class="btn btn--gray">Life</a></li><li class="tags__item"><a href="https://thehonestcoder.com/tags/security/" class="btn btn--gray">Security</a></li><li class="tags__item"><a href="https://thehonestcoder.com/tags/system-design/" class="btn btn--gray">System Design</a></li><li class="tags__item"><a href="https://thehonestcoder.com/tags/technical-leadership/" class="btn btn--gray">Technical Leadership</a></li></ul></section><div class="box follow"><a href="https://github.com/tautvydasversockas" class="tltp tltp--top" target="_blank" aria-label="GitHub"><svg><use xlink:href="https://thehonestcoder.com/assets/svg/svg-map.svg#github"/></svg> </a><a href="https://x.com/TheHonestCoder" class="tltp tltp--top" target="_blank" aria-label="Twitter"><svg><use xlink:href="https://thehonestcoder.com/assets/svg/svg-map.svg#twitter"/></svg> </a><a href="https://www.linkedin.com/in/tautvydasversockas/" class="tltp tltp--top" target="_blank" aria-label="LinkedIn"><svg><use xlink:href="https://thehonestcoder.com/assets/svg/svg-map.svg#linkedin"/></svg> </a><a href="https://thehonestcoder.com/feed.xml" class="tltp tltp--top" target="_blank" aria-label="RSS"><svg><use xlink:href="https://thehonestcoder.com/assets/svg/svg-map.svg#rss"/></svg></a></div><div class="box copyright">Â© 2025 Tautvydas Versockas</div></div></div></div></div><script defer="defer" src="https://thehonestcoder.com/assets/js/scripts.min.js?v=b2d91bcadbf5db401b76eb5bb3092eb7"></script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><script>'use strict'; document.addEventListener('DOMContentLoaded', function() { var obfElements = document.querySelectorAll('.obfuscated-email'); obfElements.forEach(function(elem) { var dataType = elem.getAttribute('data-type'); var encodedEmail = elem.getAttribute('data-email'); var user = elem.getAttribute('data-user'); var domain = elem.getAttribute('data-domain'); var decodedEmail = ''; if (user && domain) { decodedEmail = user.split('').reverse().join('') + '@' + domain.split('').reverse().join(''); } else if (encodedEmail) { const parts = encodedEmail.split('@'); if (parts.length === 2) { decodedEmail = parts[0].split('').reverse().join('') + '@' + parts[1].split('').reverse().join(''); } else { decodedEmail = encodedEmail; } } if (dataType === 'mailto') { var originalText = elem.textContent.trim(); var a = document.createElement('a'); a.href = 'mailto:' + decodedEmail; if (elem.classList.length > 0) { a.className = elem.className; } if (originalText === '') { a.textContent = decodedEmail; } else { a.textContent = originalText; } elem.parentNode.replaceChild(a, elem); } else if (dataType === 'text') { var textNode = document.createTextNode(decodedEmail); elem.parentNode.replaceChild(textNode, elem); } }); });</script><script type="text/javascript">document.addEventListener("DOMContentLoaded", function() {
            if (window.location.pathname !== '/') {
                function calculateReadingTime() {
                    let totalWords = 0;

                    const textElements = document.querySelectorAll('.content__entry p');
                    textElements.forEach(element => {
                        totalWords += element.innerText.split(' ').filter(Boolean).length;
                    });

                    const headerElements = document.querySelectorAll('.content__entry .wp-block-heading');
                    headerElements.forEach(element => {
                        totalWords += element.innerText.split(' ').filter(Boolean).length;
                    });

                    const codeElements = document.querySelectorAll('.content__entry pre code');
                    codeElements.forEach(element => {
                        totalWords += element.innerText.split(' ').filter(Boolean).length;
                    });

                    const wordsPerMinute = 200;
                    const readingTimeDecimal = totalWords / wordsPerMinute;
                    const readingTimeMinutes = Math.floor(readingTimeDecimal);
                    const fractionalMinute = readingTimeDecimal - readingTimeMinutes;
                    const readingTimeSeconds = Math.round(fractionalMinute * 60);
                    const timeString = readingTimeMinutes + (readingTimeSeconds > 29 ? 1 :0);
                    const finalText = '%s min read'.replace('%s', timeString);

                    const readingTimeElement = document.createElement('div');
                    readingTimeElement.className = 'reading-time';                
                    readingTimeElement.textContent = finalText;
                    const targetElement = document.querySelector('.date-meta-separator');
                    if (targetElement) 
                        targetElement.insertAdjacentElement('afterend', readingTimeElement);
                }
                calculateReadingTime();
            }            
        });</script><script defer="defer" src="https://thehonestcoder.com/media/plugins/syntaxHighlighter/prism.js"></script><script defer="defer" src="https://thehonestcoder.com/media/plugins/syntaxHighlighter/clipboard.min.js"></script><script defer="defer" src="https://thehonestcoder.com/media/plugins/syntaxHighlighter/prism-copy-to-clipboard.min.js"></script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">We use cookies to enhance your browsing experience and analyze our traffic.</div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--link pcb__btn--configure" aria-haspopup="dialog">Manage preferences</button> <button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><div class="pcb__popup" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-popup-title"><div class="pcb__popup__wrapper"><div class="pcb__inner pcb__popup__inner"><div class="pcb__popup__heading"><div id="pcb-popup-title" role="heading" aria-level="2" class="pcb__title">Cookie settings</div><button class="pcb__popup__close" aria-label="Close"></button></div><div class="pcb__popup__content"><div class="pcb__txt pcb__popup__txt">We use cookies to enhance your browsing experience and analyze our traffic. By clicking "Accept All", you consent to our use of cookies.</div><ul class="pcb__groups"><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Analytics</summary></details><div class="pcb__popup__switch"><input type="checkbox" data-group-name="analytics" id="analytics-cookies"> <label for="analytics-cookies">Analytics</label></div></li></ul></div><div class="pcb__buttons pcb__popup__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button> <button type="button" class="pcb__btn pcb__btn--reject"></button> <button type="button" class="pcb__btn pcb__btn--save">Save settings</button></div></div></div></div><div class="pcb__overlay" aria-hidden="true"></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>window.dataLayer = window.dataLayer || [];
                function gtag() { dataLayer.push(arguments); }

                window.publiiCBGCM = {
                    defaultState: {"ad_storage":false,"ad_personalization":false,"ad_user_data":false,"analytics_storage":true,"personalization_storage":false,"functionality_storage":false,"security_storage":false},
                    groups: [{"cookieGroup":"","ad_storage":false,"ad_personalization":false,"ad_user_data":false,"analytics_storage":true,"personalization_storage":false,"functionality_storage":false,"security_storage":false}]
                };
            
            (function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('ðŸª Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('ðŸª GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('ðŸª Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('ðŸª GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('ðŸª Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && (!cbConfig.initialLsState || cbConfig.initialLsState.indexOf(allowedGroup) === -1)) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('ðŸª GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('ðŸª Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('ðŸª Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('ðŸª Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('ðŸª Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>